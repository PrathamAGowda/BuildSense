<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BuildSense</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #0d0f18;
        --surface: #13161f;
        --surface2: #1a1d2b;
        --card: #1c1f2e;
        --border: #252840;
        --accent: #4f8ef7;
        --green: #34d399;
        --amber: #fbbf24;
        --red: #f87171;
        --text: #e2e8f0;
        --fg: #e2e8f0;
        --sub: #94a3b8;
        --radius: 10px;
        --sidebar: 210px;
      }

      body {
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
        overflow: hidden;
      }

      /* Sidebar */
      aside {
        width: var(--sidebar);
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        height: 100vh;
        overflow-y: auto;
      }
      .logo {
        padding: 1.2rem 1.15rem 0.95rem;
        font-size: 1rem;
        font-weight: 800;
        letter-spacing: 0.04em;
        color: var(--text);
        border-bottom: 1px solid var(--border);
      }
      .logo em {
        color: var(--accent);
        font-style: normal;
      }
      nav {
        padding: 0.6rem 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 1px;
      }
      .nav-section {
        font-size: 0.62rem;
        font-weight: 700;
        color: var(--sub);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 0.8rem 0.7rem 0.25rem;
      }
      nav button {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--sub);
        padding: 0.5rem 0.75rem;
        border-radius: 7px;
        font-size: 0.81rem;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.12s;
        width: 100%;
      }
      nav button:hover {
        color: var(--text);
        background: rgba(255, 255, 255, 0.04);
      }
      nav button.active {
        color: var(--accent);
        background: rgba(79, 142, 247, 0.12);
        font-weight: 600;
      }
      nav button .ico {
        width: 16px;
        text-align: center;
        font-size: 0.85rem;
      }

      /* Nav badge ‚Äî red dot for pending reorders */
      .nav-badge {
        margin-left: auto;
        background: var(--red);
        color: #fff;
        font-size: 0.6rem;
        font-weight: 700;
        min-width: 16px;
        height: 16px;
        border-radius: 99px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
        animation: pulse-badge 1.8s ease-in-out infinite;
      }
      @keyframes pulse-badge {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.55;
        }
      }

      /* Startup overlay */
      #setup-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.72);
        backdrop-filter: blur(6px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #setup-modal {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 2rem 2.4rem;
        width: 480px;
        max-width: 95vw;
      }
      #setup-modal h2 {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 0.3rem;
      }
      #setup-modal .sub {
        font-size: 0.78rem;
        color: var(--sub);
        margin-bottom: 1.2rem;
      }
      #setup-modal label {
        display: block;
        font-size: 0.74rem;
        color: var(--sub);
        margin-bottom: 0.25rem;
        margin-top: 0.7rem;
      }
      #setup-modal input {
        width: 100%;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 7px;
        color: var(--text);
        padding: 0.5rem 0.75rem;
        font-size: 0.84rem;
      }
      #setup-modal input:focus {
        outline: none;
        border-color: var(--accent);
      }

      /* Main */
      main {
        flex: 1;
        overflow-y: auto;
        padding: 2rem 2.5rem;
      }

      .section {
        display: none;
      }
      .section.active {
        display: block;
      }

      .page-hd {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }
      .page-sub {
        color: var(--sub);
        font-size: 0.82rem;
        margin-bottom: 1.4rem;
        line-height: 1.55;
      }

      /* Cards */
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.1rem 1.3rem;
        margin-bottom: 0.9rem;
      }
      .card-hd {
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        color: var(--sub);
        margin-bottom: 0.85rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(255px, 1fr));
        gap: 0.8rem;
      }

      /* Forms */
      .row {
        display: flex;
        gap: 0.65rem;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 0.28rem;
        flex: 1;
        min-width: 110px;
      }
      label {
        font-size: 0.72rem;
        color: var(--sub);
        font-weight: 500;
      }
      input,
      select {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 7px;
        color: var(--text);
        padding: 0.45rem 0.65rem;
        font-size: 0.82rem;
        width: 100%;
        outline: none;
        transition: border-color 0.15s;
      }
      input:focus,
      select:focus {
        border-color: var(--accent);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.46rem 1rem;
        border-radius: 7px;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.12s;
        white-space: nowrap;
      }
      .btn-primary {
        background: var(--accent);
        color: #fff;
      }
      .btn-primary:hover {
        background: #3a7de8;
      }
      .btn-ok {
        background: #059669;
        color: #fff;
      }
      .btn-ok:hover {
        background: #047857;
      }
      .btn-ghost {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .btn-ghost:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .btn:disabled {
        opacity: 0.38;
        cursor: not-allowed;
      }

      /* Stat chips */
      .stats {
        display: flex;
        gap: 0.55rem;
        flex-wrap: wrap;
      }
      .stat {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.55rem 0.85rem;
        min-width: 95px;
      }
      .stat-label {
        font-size: 0.66rem;
        color: var(--sub);
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .stat-value {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--accent);
        margin-top: 0.08rem;
      }
      .good {
        color: var(--green) !important;
      }
      .warn {
        color: var(--amber) !important;
      }
      .bad {
        color: var(--red) !important;
      }

      /* Banners */
      .banner {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 0.85rem;
        border-radius: 8px;
        font-size: 0.82rem;
        margin-bottom: 0.85rem;
        border-left: 3px solid;
      }
      .b-ok {
        background: rgba(52, 211, 153, 0.07);
        border-color: var(--green);
        color: var(--green);
      }
      .b-warn {
        background: rgba(251, 191, 36, 0.07);
        border-color: var(--amber);
        color: var(--amber);
      }
      .b-err {
        background: rgba(248, 113, 113, 0.07);
        border-color: var(--red);
        color: var(--red);
      }
      .b-info {
        background: rgba(79, 142, 247, 0.07);
        border-color: var(--accent);
        color: var(--accent);
      }

      /* Progress */
      .prog {
        background: var(--surface);
        border-radius: 99px;
        height: 5px;
        overflow: hidden;
        margin: 0.45rem 0;
      }
      .prog-fill {
        height: 100%;
        border-radius: 99px;
        transition: width 0.35s;
      }

      /* Tables */
      .tbl-wrap {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }
      th {
        text-align: left;
        padding: 0.45rem 0.7rem;
        color: var(--sub);
        font-size: 0.67rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--border);
      }
      td {
        padding: 0.45rem 0.7rem;
        border-bottom: 1px solid rgba(37, 40, 64, 0.5);
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover td {
        background: rgba(79, 142, 247, 0.025);
      }

      /* Mini bar chart */
      .bars {
        display: flex;
        align-items: flex-end;
        gap: 3px;
        height: 66px;
        margin: 0.55rem 0;
      }
      .bar-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        flex: 1;
      }
      .bar {
        background: var(--accent);
        border-radius: 3px 3px 0 0;
        width: 100%;
        min-height: 2px;
      }
      .bar-lbl {
        font-size: 0.56rem;
        color: var(--sub);
      }

      /* Misc */
      hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 0.85rem 0;
      }
      .sub {
        color: var(--sub);
        font-size: 0.78rem;
      }
      .mt {
        margin-top: 0.65rem;
      }
      .truck-entry {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.45rem;
      }

      /* Delivery map */
      #d-map-container {
        border-radius: var(--radius);
        overflow: hidden;
        border: 1px solid var(--border);
        margin-bottom: 1rem;
      }
      #delivery-map {
        width: 100%;
        height: 420px;
        background: var(--surface);
      }

      /* Role-colour legend dots in stop list */
      .stop-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
        border: 2px solid rgba(255, 255, 255, 0.25);
      }

      /* Toast */
      #toast {
        position: fixed;
        bottom: 1.2rem;
        right: 1.2rem;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.55rem 0.95rem;
        font-size: 0.8rem;
        box-shadow: 0 4px 22px rgba(0, 0, 0, 0.55);
        transform: translateY(50px) scale(0.95);
        opacity: 0;
        transition: all 0.2s;
        z-index: 999;
        max-width: 280px;
        pointer-events: none;
      }
      #toast.show {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  </head>
  <body>
    <!-- ‚îÄ‚îÄ Project Setup Overlay (shown once on first visit) ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="setup-overlay">
      <div id="setup-modal">
        <h2>üèó Welcome to BuildSense</h2>
        <p class="sub">
          Set your project destination once ‚Äî all auto-reorder deliveries will
          be sent here automatically.
        </p>

        <label>Project Name</label>
        <input
          id="setup-project-name"
          placeholder="e.g. Koramangala Tower Block A"
        />

        <label>Destination / Site Address</label>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem">
          <input
            id="setup-geo-input"
            placeholder="Search city or address‚Ä¶"
            style="flex: 1"
            onkeydown="if (event.key === 'Enter') setupGeoSearch();"
          />
          <button
            class="btn btn-ghost"
            style="white-space: nowrap"
            onclick="setupGeoSearch()"
          >
            Search
          </button>
        </div>
        <div id="setup-geo-results" style="margin-top: 0.4rem"></div>

        <div
          id="setup-coords-display"
          style="
            display: none;
            margin-top: 0.6rem;
            padding: 0.5rem 0.75rem;
            background: var(--surface2);
            border-radius: 8px;
            font-size: 0.76rem;
            color: var(--green);
          "
        >
          üìç <span id="setup-coords-label"></span>
        </div>

        <button
          class="btn btn-primary"
          style="width: 100%; margin-top: 1.1rem; padding: 0.65rem"
          onclick="saveProjectSetup()"
        >
          Save &amp; Start ‚Üí
        </button>
        <button
          style="
            background: none;
            border: none;
            color: var(--sub);
            font-size: 0.74rem;
            cursor: pointer;
            width: 100%;
            margin-top: 0.5rem;
            text-align: center;
          "
          onclick="skipSetup()"
        >
          Skip for now (you can set this later in Settings)
        </button>
      </div>
    </div>

    <!-- Sidebar -->
    <aside>
      <div class="logo">Build<em>Sense</em></div>
      <nav id="nav">
        <div class="nav-section">Overview</div>
        <button class="active" onclick="goto('materials')">
          <span class="ico">‚¨°</span> Materials
        </button>

        <div class="nav-section">Workflow</div>
        <button onclick="goto('initialize')">
          <span class="ico">‚ú¶</span> Initialize
        </button>
        <button onclick="goto('order')">
          <span class="ico">‚Üó</span> Smart Order
        </button>
        <button onclick="goto('inventory')">
          <span class="ico">‚óé</span> Inventory
        </button>
        <button onclick="goto('reorder')" id="nav-reorder-btn">
          <span class="ico">‚ñ≥</span> Reorder
          <span
            class="nav-badge"
            id="reorder-nav-badge"
            style="display: none"
          ></span>
        </button>
        <button onclick="goto('complete')">
          <span class="ico">‚úì</span> Close Phase
        </button>

        <div class="nav-section">Logistics</div>
        <button onclick="goto('delivery')">
          <span class="ico">‚¨°</span> Delivery
        </button>
      </nav>
    </aside>

    <!-- Content -->
    <main>
      <!-- Materials -->
      <div class="section active" id="s-materials">
        <div class="page-hd">Materials</div>
        <div class="page-sub">
          All tracked construction materials with adaptive waste buffers.
        </div>
        <div class="card">
          <div class="card-hd">Add Material</div>
          <div class="row">
            <div class="field">
              <label>Name</label
              ><input id="new-name" placeholder="e.g. Gravel" />
            </div>
            <div class="field">
              <label>Unit</label><input id="new-unit" placeholder="e.g. tons" />
            </div>
            <div class="field" style="max-width: 95px">
              <label>Buffer %</label
              ><input id="new-buf" type="number" value="5" min="0" max="100" />
            </div>
            <div class="field" style="max-width: 115px">
              <label>Weight/unit (kg)</label
              ><input id="new-wt" type="number" value="1.0" step="0.1" />
            </div>
            <div class="field" style="max-width: 95px">
              <label>Priority 1‚Äì10</label
              ><input id="new-pri" type="number" value="5" min="1" max="10" />
            </div>
            <button class="btn btn-primary" onclick="addMaterial()">Add</button>
          </div>
        </div>
        <div id="mat-cards" class="grid"></div>
      </div>

      <!-- Initialize -->
      <div class="section" id="s-initialize">
        <div class="page-hd">Initialize Phase</div>
        <div class="page-sub">
          Set planned quantities for a new project phase. Ordered amounts with
          buffer are calculated and saved immediately.
        </div>
        <div class="card">
          <div class="row" style="margin-bottom: 0.8rem">
            <div class="field" style="max-width: 230px">
              <label>Phase Name</label>
              <input id="p1-phase" placeholder="e.g. Foundation" />
            </div>
          </div>
          <div id="p1-rows"></div>
          <div style="display: flex; gap: 0.45rem; margin-top: 0.55rem">
            <button class="btn btn-ghost" onclick="addP1Row()">
              + Material
            </button>
            <button class="btn btn-primary" onclick="submitP1()">Save</button>
          </div>
        </div>
        <div id="p1-output"></div>
      </div>

      <!-- Smart Order -->
      <div class="section" id="s-order">
        <div class="page-hd">Smart Order</div>
        <div class="page-sub">
          Enter planned quantity. The system applies the adaptive buffer to
          recommend a safe order amount.
        </div>
        <div class="card">
          <div class="row">
            <div class="field">
              <label>Material</label
              ><select id="p2-mat"></select>
            </div>
            <div class="field" style="max-width: 170px">
              <label>Planned Quantity</label
              ><input
                id="p2-qty"
                type="number"
                placeholder="e.g. 200"
                step="any"
                min="0.001"
              />
            </div>
            <button class="btn btn-primary" onclick="smartOrder()">
              Calculate
            </button>
          </div>
        </div>
        <div id="p2-output"></div>
      </div>

      <!-- Inventory -->
      <div class="section" id="s-inventory">
        <div class="page-hd">Inventory Tracking</div>
        <div class="page-sub">
          Log daily consumption and monitor live stock levels per phase.
        </div>

        <div class="card">
          <div class="card-hd">Log Usage</div>
          <div class="row">
            <div class="field">
              <label>Material</label
              ><select id="p3-mat" onchange="loadPhases('p3')"></select>
            </div>
            <div class="field">
              <label>Phase</label
              ><select id="p3-phase" onchange="renderPhaseSnapshot()"></select>
            </div>
            <div class="field" style="max-width: 145px">
              <label>Quantity Used</label
              ><input
                id="p3-qty"
                type="number"
                placeholder="e.g. 18.5"
                step="any"
                min="0"
              />
            </div>
            <div class="field" style="max-width: 150px">
              <label>Date</label><input id="p3-date" type="date" />
            </div>
            <button class="btn btn-ok" onclick="logDailyUsage()">Log</button>
          </div>
        </div>

        <div id="p3-output"></div>

        <!-- Auto-Reorder Site Panel -->
        <div class="card" id="p3-site-card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.6rem;
            "
          >
            <div>
              <div class="card-hd" style="margin-bottom: 0.1rem">
                ü§ñ Auto-Reorder Intelligence
              </div>
              <div class="sub" style="font-size: 0.72rem">
                Set your site location once ‚Äî every daily log automatically
                predicts stockout via EMA and sources materials from the nearest
                stores if needed.
              </div>
            </div>
          </div>
          <div
            class="row"
            style="gap: 0.5rem; align-items: flex-end; flex-wrap: wrap"
          >
            <div class="field" style="flex: 1; min-width: 180px">
              <label>Site / Destination</label>
              <input
                id="ar-geo-input"
                type="text"
                placeholder="e.g. Jaipur, Rajasthan"
                onkeydown="if (event.key === 'Enter') arGeoSearch();"
                style="width: 100%"
              />
            </div>
            <button
              class="btn btn-ghost"
              onclick="arGeoSearch()"
              style="margin-bottom: 0"
            >
              üîç Search
            </button>
            <button
              class="btn btn-ghost"
              onclick="runAllReorderCheck()"
              style="margin-bottom: 0; color: var(--accent)"
            >
              ‚ö° Check All Now
            </button>
          </div>
          <div
            id="ar-geo-results"
            style="
              display: none;
              margin-top: 0.5rem;
              border: 1px solid var(--border);
              border-radius: var(--radius);
              overflow: hidden;
            "
          ></div>
          <div
            id="ar-site-badge"
            style="
              display: none;
              margin-top: 0.55rem;
              padding: 0.45rem 0.8rem;
              background: rgba(39, 174, 96, 0.1);
              border: 1px solid rgba(39, 174, 96, 0.35);
              border-radius: var(--radius);
              font-size: 0.79rem;
              display: flex;
              align-items: center;
              gap: 0.6rem;
            "
          >
            <span>üìç</span>
            <span id="ar-site-label">‚Äî</span>
            <button
              class="btn btn-ghost"
              onclick="arClearSite()"
              style="
                margin-left: auto;
                font-size: 0.72rem;
                padding: 0.2rem 0.5rem;
              "
            >
              ‚úï
            </button>
          </div>
          <div id="ar-all-output"></div>
        </div>

        <div class="card">
          <div class="card-hd">Manual Snapshot</div>
          <div class="row">
            <div class="field">
              <label>Ordered Qty</label
              ><input
                id="p3-ordered"
                type="number"
                placeholder="212"
                step="any"
              />
            </div>
            <div class="field">
              <label>Consumed So Far</label
              ><input
                id="p3-consumed"
                type="number"
                placeholder="150"
                step="any"
              />
            </div>
            <div class="field">
              <label>Carry-in Stock</label
              ><input id="p3-carryin" type="number" value="0" step="any" />
            </div>
            <button class="btn btn-ghost" onclick="inventoryStatus()">
              Check
            </button>
          </div>
          <div id="p3-manual"></div>
        </div>

        <!-- Forecast card -->
        <div class="card" id="p3-forecast-card" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.85rem;
            "
          >
            <div>
              <div class="card-hd" style="margin-bottom: 0.1rem">
                Consumption Forecast
              </div>
              <div class="sub" style="font-size: 0.73rem">
                MA below 14-day threshold ¬∑ ARMA/ARIMA above
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <div class="field" style="max-width: 100px; margin: 0">
                <label style="font-size: 0.67rem">Days ahead</label>
                <input
                  id="p3-fc-horizon"
                  type="number"
                  value="14"
                  min="1"
                  max="90"
                  style="padding: 0.3rem 0.55rem"
                />
              </div>
              <button
                class="btn btn-primary"
                style="margin-top: 0.95rem"
                onclick="runForecast()"
              >
                Forecast
              </button>
            </div>
          </div>
          <div id="p3-fc-output"></div>
        </div>
      </div>

      <!-- Reorder -->
      <div class="section" id="s-reorder">
        <div class="page-hd">Reorder</div>
        <div class="page-sub">
          AI-triggered reorder requests awaiting your approval ¬∑ approve to
          auto-source from nearest depots.
        </div>

        <!-- ‚îÄ‚îÄ Pending Approvals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="card" id="pending-approvals-card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.85rem;
            "
          >
            <div>
              <div class="card-hd" style="margin-bottom: 0.1rem">
                ‚è≥ Pending Approvals
                <span
                  id="pending-count-badge"
                  style="
                    display: none;
                    margin-left: 0.5rem;
                    background: var(--red);
                    color: #fff;
                    font-size: 0.65rem;
                    font-weight: 700;
                    padding: 0.1rem 0.45rem;
                    border-radius: 99px;
                    vertical-align: middle;
                  "
                ></span>
              </div>
              <div class="sub" style="font-size: 0.73rem">
                Auto-detected by EMA engine ¬∑ click Approve to instantly source
                &amp; book delivery
              </div>
            </div>
            <button
              class="btn btn-ghost"
              style="font-size: 0.8rem; padding: 0.35rem 0.8rem"
              onclick="loadPendingReorders()"
            >
              ‚Üª Refresh
            </button>
          </div>
          <div id="pending-reorders-output">
            <div class="sub" style="text-align: center; padding: 1.2rem 0">
              Loading‚Ä¶
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Manual Reorder Check (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="card" style="margin-top: 1.1rem">
          <div class="card-hd" style="margin-bottom: 0.7rem">
            Manual Snapshot Check
          </div>
          <div class="row">
            <div class="field">
              <label>Material</label
              ><select id="p4-mat"></select>
            </div>
            <div class="field">
              <label>Ordered Qty</label
              ><input
                id="p4-ordered"
                type="number"
                placeholder="212"
                step="any"
              />
            </div>
            <div class="field">
              <label>Current Remaining</label
              ><input
                id="p4-remaining"
                type="number"
                placeholder="40"
                step="any"
              />
            </div>
            <div class="field">
              <label>Next Phase Planned</label
              ><input
                id="p4-planned"
                type="number"
                placeholder="200"
                step="any"
              />
            </div>
            <button class="btn btn-primary" onclick="reorderCheck()">
              Check
            </button>
          </div>
        </div>
        <div id="p4-output"></div>
      </div>

      <!-- Close Phase -->
      <div class="section" id="s-complete">
        <div class="page-hd">Close Phase</div>
        <div class="page-sub">
          Record actual consumption. Waste percentage is calculated and the
          buffer is adapted via EMA for future orders.
        </div>
        <div class="card">
          <div class="row" style="margin-bottom: 0.7rem">
            <div class="field">
              <label>Material</label
              ><select id="p5-mat"></select>
            </div>
            <div class="field">
              <label>Phase Name</label
              ><input id="p5-phase" placeholder="e.g. Foundation" />
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Planned Qty</label
              ><input
                id="p5-planned"
                type="number"
                placeholder="200"
                step="any"
              />
            </div>
            <div class="field">
              <label>Ordered Qty</label
              ><input
                id="p5-ordered"
                type="number"
                placeholder="212"
                step="any"
              />
            </div>
            <div class="field">
              <label>Consumed Qty</label
              ><input
                id="p5-consumed"
                type="number"
                placeholder="195"
                step="any"
              />
            </div>
            <div class="field" style="max-width: 120px">
              <label>Carry-in</label
              ><input id="p5-carryin" type="number" value="0" step="any" />
            </div>
          </div>
          <div style="display: flex; gap: 0.45rem; margin-top: 0.7rem">
            <button class="btn btn-primary" onclick="completePhase()">
              Close Phase
            </button>
            <button class="btn btn-ghost" onclick="loadHistory()">
              View History
            </button>
          </div>
        </div>
        <div id="p5-output"></div>
        <div id="p5-history"></div>

        <!-- ‚îÄ‚îÄ Reorder Transaction Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="card" style="margin-top: 1.4rem">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.85rem;
            "
          >
            <div>
              <div class="card-hd" style="margin-bottom: 0.1rem">
                üìã Reorder Transaction Log
              </div>
              <div class="sub" style="font-size: 0.73rem">
                All auto-triggered reorder events ¬∑ newest first
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center">
              <button
                class="btn btn-ghost"
                style="font-size: 0.8rem; padding: 0.35rem 0.8rem"
                onclick="loadReorderLogs()"
              >
                ‚Üª Refresh
              </button>
              <button
                class="btn"
                style="
                  font-size: 0.8rem;
                  padding: 0.35rem 0.8rem;
                  background: var(--danger, #ef4444);
                  color: #fff;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                "
                onclick="clearReorderLogs()"
              >
                üóë Clear All
              </button>
            </div>
          </div>
          <div id="reorder-log-output">
            <div class="sub" style="text-align: center; padding: 1.2rem 0">
              Click ‚Üª Refresh to load logs.
            </div>
          </div>
        </div>
      </div>

      <!-- Delivery / Supply Network -->
      <div class="section" id="s-delivery">
        <div class="page-hd">Supply Network Planner</div>
        <div class="page-sub">
          Enter your destination and material requirements ‚Äî BuildSense
          automatically sources everything from the nearest stores across India
          and plans optimal truck routes from the closest depots.
        </div>

        <!-- Network info bar -->
        <div
          id="sn-info-bar"
          style="
            display: flex;
            gap: 0.7rem;
            flex-wrap: wrap;
            margin-bottom: 0.3rem;
          "
        >
          <div
            class="card"
            style="margin: 0; flex: 1; min-width: 130px; padding: 0.9rem 1.1rem"
          >
            <div class="sub" style="font-size: 0.72rem; margin-bottom: 0.25rem">
              üè≠ DEPOTS
            </div>
            <div
              id="sn-depot-count"
              style="font-size: 1.5rem; font-weight: 700; color: var(--accent)"
            >
              ‚Äî
            </div>
          </div>
          <div
            class="card"
            style="margin: 0; flex: 1; min-width: 130px; padding: 0.9rem 1.1rem"
          >
            <div class="sub" style="font-size: 0.72rem; margin-bottom: 0.25rem">
              üè™ STORES
            </div>
            <div
              id="sn-store-count"
              style="font-size: 1.5rem; font-weight: 700; color: var(--green)"
            >
              ‚Äî
            </div>
          </div>
          <div
            class="card"
            style="margin: 0; flex: 2; min-width: 200px; padding: 0.9rem 1.1rem"
          >
            <div class="sub" style="font-size: 0.72rem; margin-bottom: 0.25rem">
              üìç DEPOT HUBS
            </div>
            <div
              id="sn-depot-names"
              style="font-size: 0.8rem; color: var(--fg); line-height: 1.5"
            >
              ‚Äî
            </div>
          </div>
        </div>

        <!-- Step 1 ‚Äî Destination -->
        <div class="card">
          <div class="card-hd">‚ë† Destination</div>
          <div class="sub" style="margin-bottom: 0.8rem; font-size: 0.78rem">
            Search for your construction site or delivery location anywhere in
            India.
          </div>
          <div
            class="row"
            style="gap: 0.5rem; align-items: flex-end; flex-wrap: wrap"
          >
            <div class="field" style="flex: 1; min-width: 200px">
              <label>Search destination</label>
              <input
                id="sn-geo-input"
                type="text"
                placeholder="e.g. Jaipur, Rajasthan"
                onkeydown="if (event.key === 'Enter') snGeoSearch();"
                style="width: 100%"
              />
            </div>
            <button
              class="btn btn-ghost"
              onclick="snGeoSearch()"
              style="margin-bottom: 0"
            >
              üîç Search
            </button>
          </div>
          <div
            id="sn-geo-results"
            style="
              display: none;
              margin-top: 0.5rem;
              border: 1px solid var(--border);
              border-radius: var(--radius);
              overflow: hidden;
            "
          ></div>
          <div
            id="sn-dest-badge"
            style="
              display: none;
              margin-top: 0.7rem;
              padding: 0.55rem 0.9rem;
              background: rgba(192, 57, 43, 0.12);
              border: 1px solid rgba(192, 57, 43, 0.35);
              border-radius: var(--radius);
              font-size: 0.82rem;
              color: var(--fg);
              display: flex;
              align-items: center;
              gap: 0.6rem;
            "
          >
            <span style="font-size: 1rem">üìç</span>
            <span id="sn-dest-label">‚Äî</span>
            <button
              class="btn btn-ghost"
              onclick="snClearDest()"
              style="
                margin-left: auto;
                font-size: 0.72rem;
                padding: 0.2rem 0.5rem;
              "
            >
              ‚úï
            </button>
          </div>
        </div>

        <!-- Step 2 ‚Äî Requirements -->
        <div class="card">
          <div class="card-hd">‚ë° Material Requirements</div>
          <div class="sub" style="margin-bottom: 0.8rem; font-size: 0.78rem">
            Enter the quantity needed for each material. Leave blank or zero to
            skip.
          </div>
          <div
            id="sn-req-rows"
            style="display: flex; flex-direction: column; gap: 0.4rem"
          ></div>
        </div>

        <!-- Plan button -->
        <div style="display: flex; justify-content: flex-end">
          <button
            class="btn btn-primary"
            style="min-width: 160px"
            onclick="planSupply()"
          >
            ‚ö° Plan Supply
          </button>
        </div>

        <!-- Map -->
        <div id="d-map-container">
          <div id="delivery-map"></div>
        </div>

        <!-- Results -->
        <div id="sn-output"></div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ Advanced: Manual Route Builder (collapsible) ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <details style="margin-top: 1.2rem">
          <summary
            style="
              cursor: pointer;
              font-size: 0.82rem;
              color: var(--sub);
              padding: 0.5rem 0;
              user-select: none;
            "
          >
            ‚ñ∏ Advanced ‚Äî Custom Route Builder
          </summary>

          <div style="margin-top: 0.8rem">
            <div class="card">
              <div class="card-hd">Route Builder</div>
              <div
                class="sub"
                style="margin-bottom: 0.8rem; font-size: 0.78rem"
              >
                Search for a city or address, then click
                <strong>Set as Source</strong>, <strong>Add Stop</strong>, or
                <strong>Set as Destination</strong>.
              </div>
              <div
                class="row"
                style="gap: 0.5rem; align-items: flex-end; flex-wrap: wrap"
              >
                <div class="field" style="flex: 1; min-width: 200px">
                  <label>Search location</label>
                  <input
                    id="geo-input"
                    type="text"
                    placeholder="e.g. Mumbai, India"
                    onkeydown="if (event.key === 'Enter') geocodeSearch();"
                    style="width: 100%"
                  />
                </div>
                <button
                  class="btn btn-ghost"
                  onclick="geocodeSearch()"
                  style="margin-bottom: 0"
                >
                  üîç Search
                </button>
              </div>
              <div
                id="geo-results"
                style="
                  display: none;
                  margin-top: 0.5rem;
                  border: 1px solid var(--border);
                  border-radius: var(--radius);
                  overflow: hidden;
                "
              ></div>
              <div
                style="
                  margin-top: 0.6rem;
                  display: flex;
                  gap: 0.4rem;
                  flex-wrap: wrap;
                "
              >
                <button
                  class="btn btn-ghost"
                  onclick="addPendingAsStop('source')"
                  style="
                    font-size: 0.76rem;
                    display: flex;
                    align-items: center;
                    gap: 0.35rem;
                  "
                >
                  <span
                    style="
                      display: inline-block;
                      width: 10px;
                      height: 10px;
                      border-radius: 50%;
                      background: #27ae60;
                      flex-shrink: 0;
                    "
                  ></span>
                  Set as Source
                </button>
                <button
                  class="btn btn-ghost"
                  onclick="addPendingAsStop('stop')"
                  style="
                    font-size: 0.76rem;
                    display: flex;
                    align-items: center;
                    gap: 0.35rem;
                  "
                >
                  <span
                    style="
                      display: inline-block;
                      width: 10px;
                      height: 10px;
                      border-radius: 50%;
                      background: #2980b9;
                      flex-shrink: 0;
                    "
                  ></span>
                  Add as Stop
                </button>
                <button
                  class="btn btn-ghost"
                  onclick="addPendingAsStop('dest')"
                  style="
                    font-size: 0.76rem;
                    display: flex;
                    align-items: center;
                    gap: 0.35rem;
                  "
                >
                  <span
                    style="
                      display: inline-block;
                      width: 10px;
                      height: 10px;
                      border-radius: 50%;
                      background: #c0392b;
                      flex-shrink: 0;
                    "
                  ></span>
                  Set as Destination
                </button>
              </div>
              <div
                id="route-stops"
                style="
                  margin-top: 0.9rem;
                  display: flex;
                  flex-direction: column;
                  gap: 0.35rem;
                "
              ></div>
              <div
                style="
                  margin-top: 0.7rem;
                  display: flex;
                  gap: 0.5rem;
                  flex-wrap: wrap;
                  align-items: center;
                "
              >
                <button
                  class="btn btn-ghost"
                  onclick="clearRoute()"
                  style="font-size: 0.76rem"
                >
                  ‚úï Clear Route
                </button>
                <span
                  id="route-summary"
                  class="sub"
                  style="font-size: 0.76rem"
                ></span>
              </div>
            </div>

            <div class="card">
              <div class="card-hd">Dispatch Quantities</div>
              <div id="d-mat-rows"></div>
            </div>
            <div class="card">
              <div class="card-hd">Truck Fleet</div>
              <div id="d-trucks"></div>
              <div
                style="
                  display: flex;
                  gap: 0.5rem;
                  align-items: center;
                  margin-top: 0.7rem;
                  flex-wrap: wrap;
                "
              >
                <button class="btn btn-ghost" onclick="addTruck()">
                  + Truck
                </button>
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.4rem;
                    font-size: 0.8rem;
                    cursor: pointer;
                    color: var(--sub);
                  "
                >
                  <input
                    type="checkbox"
                    id="d-rain"
                    style="
                      width: 13px;
                      height: 13px;
                      accent-color: var(--accent);
                    "
                  />
                  Rain expected
                </label>
                <button
                  class="btn btn-primary"
                  style="margin-left: auto"
                  onclick="planDelivery()"
                >
                  Plan Delivery
                </button>
              </div>
            </div>
            <div id="d-output"></div>
          </div>
        </details>
      </div>
    </main>

    <div id="toast"></div>

    <script>
      const API = "http://localhost:5001/api";
      let materials = [];
      const NAV_IDS = [
        "materials",
        "initialize",
        "order",
        "inventory",
        "reorder",
        "complete",
        "delivery",
      ];

      /* Navigation */
      function goto(id) {
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById("s-" + id).classList.add("active");
        document
          .querySelectorAll("nav button")
          .forEach((b, i) => b.classList.toggle("active", NAV_IDS[i] === id));
        if (id === "delivery") {
          buildDeliveryMatRows();
          buildSnReqRows();
          initDeliveryMap();
          snLoadNetworkInfo();
        }
        if (id === "inventory") {
          loadPhases("p3");
          loadReorderLogs();
        }
        if (id === "reorder") {
          loadPendingReorders();
        }
      }

      /* Toast */
      function toast(msg, type = "info") {
        const t = document.getElementById("toast");
        const c = {
          ok: "var(--green)",
          warn: "var(--amber)",
          err: "var(--red)",
          info: "var(--accent)",
        };
        t.style.color = c[type] || c.info;
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(t._tid);
        t._tid = setTimeout(() => t.classList.remove("show"), 3200);
      }

      /* API helper */
      async function api(method, path, body) {
        const opts = {
          method,
          headers: { "Content-Type": "application/json" },
        };
        if (body) opts.body = JSON.stringify(body);
        const r = await fetch(API + path, opts);
        const json = await r.json();
        if (!r.ok) throw new Error(json.error || r.statusText);
        return json;
      }

      /* Materials */
      async function loadMaterials() {
        materials = await api("GET", "/materials");
        renderMaterialCards();
        populateSelects();
      }

      function populateSelects() {
        const names = materials.map((m) => m.name);
        ["p2-mat", "p3-mat", "p4-mat", "p5-mat"].forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          const cur = el.value;
          el.innerHTML = names
            .map((n) => `<option value="${n}">${n}</option>`)
            .join("");
          if (names.includes(cur)) el.value = cur;
        });
        loadPhases("p3");
      }

      function matByName(n) {
        return materials.find((m) => m.name === n);
      }

      function renderMaterialCards() {
        document.getElementById("mat-cards").innerHTML = materials
          .map((m) => {
            const drift = (m.buffer_pct - m.baseline_buffer_pct).toFixed(2);
            const dc = +drift > 0 ? "warn" : +drift < 0 ? "bad" : "good";
            return `
<div class="card" style="margin:0;">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem;">
    <div>
      <div style="font-weight:700;font-size:.9rem;">${m.name}</div>
      <div class="sub" style="margin-top:.12rem;">${m.unit} &middot; ${m.weight_per_unit}&thinsp;kg/unit &middot; Priority&thinsp;${m.priority}</div>
    </div>
    <button class="btn btn-ghost" style="font-size:.68rem;padding:.2rem .5rem;" onclick="deleteMaterial('${m.name}')">‚úï</button>
  </div>
  <div class="stats" style="margin-bottom:.7rem;">
    <div class="stat"><div class="stat-label">Baseline</div><div class="stat-value">${m.baseline_buffer_pct.toFixed(1)}%</div></div>
    <div class="stat"><div class="stat-label">Current</div><div class="stat-value ${dc}">${m.buffer_pct.toFixed(2)}%</div></div>
    <div class="stat"><div class="stat-label">Drift</div><div class="stat-value ${dc}">${+drift >= 0 ? "+" : ""}${drift}%</div></div>
    <div class="stat"><div class="stat-label">Phases</div><div class="stat-value good">${m.phases_logged}</div></div>
  </div>
  <button class="btn btn-ghost" style="font-size:.72rem;" onclick="resetBuffer('${m.name}')">‚Ü∫ Reset Buffer</button>
</div>`;
          })
          .join("");
      }

      async function addMaterial() {
        const name = document.getElementById("new-name").value.trim();
        const unit = document.getElementById("new-unit").value.trim();
        if (!name || !unit) return toast("Name and unit required.", "warn");
        try {
          await api("POST", "/materials", {
            name,
            unit,
            baseline_buffer_pct: parseFloat(
              document.getElementById("new-buf").value,
            ),
            weight_per_unit: parseFloat(
              document.getElementById("new-wt").value,
            ),
            priority: parseInt(document.getElementById("new-pri").value),
          });
          document.getElementById("new-name").value = "";
          document.getElementById("new-unit").value = "";
          toast(`'${name}' added.`, "ok");
          await loadMaterials();
        } catch (e) {
          toast(e.message, "err");
        }
      }

      async function deleteMaterial(name) {
        if (!confirm(`Delete '${name}'?`)) return;
        await api("DELETE", `/materials/${encodeURIComponent(name)}`);
        toast(`'${name}' deleted.`, "ok");
        await loadMaterials();
      }

      async function resetBuffer(name) {
        await api(
          "POST",
          `/materials/${encodeURIComponent(name)}/reset-buffer`,
        );
        toast(`Buffer for '${name}' reset.`, "ok");
        await loadMaterials();
      }

      /* Initialize */
      function addP1Row() {
        const div = document.createElement("div");
        div.className = "row";
        div.style.marginBottom = ".45rem";
        div.innerHTML = `
<div class="field"><label>Material</label>
  <select class="p1-ms">${materials.map((m) => `<option>${m.name}</option>`).join("")}</select>
</div>
<div class="field" style="max-width:155px;"><label>Planned Qty</label>
  <input class="p1-q" type="number" placeholder="e.g. 200" step="any"/>
</div>
<button class="btn btn-ghost" style="padding:.42rem;" onclick="this.parentElement.remove()">‚úï</button>`;
        document.getElementById("p1-rows").appendChild(div);
      }

      async function submitP1() {
        const phase = document.getElementById("p1-phase").value.trim();
        if (!phase) return toast("Enter a phase name.", "warn");
        const rows = [...document.querySelectorAll("#p1-rows .row")];
        if (!rows.length) return toast("Add at least one material.", "warn");
        const plan = rows
          .map((r) => ({
            material: r.querySelector(".p1-ms").value,
            planned_qty: parseFloat(r.querySelector(".p1-q").value),
          }))
          .filter((r) => r.planned_qty > 0);
        if (!plan.length)
          return toast("Enter at least one valid quantity.", "warn");

        const results = [],
          errors = [];
        for (const p of plan) {
          try {
            results.push(
              await api("POST", "/phase/initialize", {
                material: p.material,
                phase_name: phase,
                planned_qty: p.planned_qty,
              }),
            );
          } catch (e) {
            errors.push(`${p.material}: ${e.message}`);
          }
        }
        await loadMaterials();
        errors.length
          ? toast(`Saved ${results.length}, ${errors.length} error(s).`, "warn")
          : toast(
              `'${phase}' initialized for ${results.length} material(s).`,
              "ok",
            );

        document.getElementById("p1-output").innerHTML = `
<div class="card">
  <div class="banner ${errors.length ? "b-warn" : "b-ok"}">
    ${errors.length ? "‚ö†" : "‚úì"} Phase <strong>${phase}</strong> ‚Äî ${results.length} saved${errors.length ? `, ${errors.length} failed` : ""}.
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Material</th><th>Unit</th><th>Planned</th><th>Buffer</th><th>Recommended Order</th></tr></thead>
    <tbody>
      ${results
        .map((r) => {
          const m = matByName(r.material);
          return `
      <tr>
        <td><strong>${r.material}</strong></td>
        <td>${r.unit}</td>
        <td>${r.planned_qty.toFixed(3)}</td>
        <td>${m ? m.buffer_pct.toFixed(2) + "%" : "‚Äî"}</td>
        <td class="good" style="font-weight:600;">${r.ordered_qty.toFixed(3)}</td>
      </tr>`;
        })
        .join("")}
      ${errors.map((e) => `<tr><td colspan="5" class="bad">${e}</td></tr>`).join("")}
    </tbody>
  </table></div>
</div>`;
      }

      /* Smart Order */
      async function smartOrder() {
        const mat = document.getElementById("p2-mat").value;
        const qty = parseFloat(document.getElementById("p2-qty").value);
        if (!qty || qty <= 0)
          return toast("Enter a valid planned quantity.", "warn");
        try {
          const r = await api("POST", "/phase/smart-order", {
            material: mat,
            planned_qty: qty,
          });
          const m = matByName(mat);
          const drift = m
            ? (m.buffer_pct - m.baseline_buffer_pct).toFixed(2)
            : 0;
          document.getElementById("p2-output").innerHTML = `
<div class="card">
  <div class="banner b-info">‚Üó Order recommendation for <strong>${r.material}</strong></div>
  <div class="stats">
    <div class="stat"><div class="stat-label">Planned</div><div class="stat-value">${r.planned_qty.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Buffer</div><div class="stat-value warn">${r.buffer_pct.toFixed(2)}%</div></div>
    <div class="stat"><div class="stat-label">Order Qty</div><div class="stat-value good">${r.recommended_qty.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Drift</div><div class="stat-value ${+drift >= 0 ? "warn" : "bad"}">${+drift >= 0 ? "+" : ""}${drift}%</div></div>
  </div>
  <div class="sub mt">Unit: <strong style="color:var(--text)">${r.unit}</strong> &nbsp;&middot;&nbsp; Order <strong style="color:var(--green)">${r.recommended_qty.toFixed(3)} ${r.unit}</strong> to cover ${r.planned_qty} ${r.unit} planned.</div>
</div>`;
        } catch (e) {
          toast(e.message, "err");
        }
      }

      /* Phase dropdown */
      function loadPhases(prefix) {
        const matName = document.getElementById(`${prefix}-mat`).value;
        const m = matByName(matName);
        const sel = document.getElementById(`${prefix}-phase`);
        if (!m || !m.history.length) {
          sel.innerHTML = '<option value="-1">No phases yet</option>';
          if (prefix === "p3") renderPhaseSnapshot();
          return;
        }
        sel.innerHTML = m.history
          .map((p, i) => `<option value="${i}">${p.phase_name}</option>`)
          .join("");
        sel.value = m.history.length - 1;
        if (prefix === "p3") renderPhaseSnapshot();
      }

      /* Phase snapshot */
      function renderPhaseSnapshot() {
        const matName = document.getElementById("p3-mat").value;
        const phaseI = parseInt(document.getElementById("p3-phase").value);
        const m = matByName(matName);
        const out = document.getElementById("p3-output");
        const fcCard = document.getElementById("p3-forecast-card");
        if (!m || isNaN(phaseI) || phaseI < 0 || !m.history[phaseI]) {
          out.innerHTML = "";
          fcCard.style.display = "none";
          return;
        }
        // show the forecast card whenever there's a valid phase
        fcCard.style.display = "block";
        document.getElementById("p3-fc-output").innerHTML = "";

        const h = m.history[phaseI];
        const usages = h.daily_usage || [];
        const pct =
          h.ordered_qty > 0
            ? Math.min(100, (h.consumed_qty / h.ordered_qty) * 100)
            : 0;
        const fc =
          pct >= 90
            ? "var(--red)"
            : pct >= 65
              ? "var(--amber)"
              : "var(--green)";

        let avgActive = 0,
          avgCal = 0,
          activeDays = 0,
          calDays = 0,
          daysLeft = null;
        if (usages.length) {
          const total = usages.reduce((s, e) => s + e.quantity, 0);
          activeDays = usages.length;
          avgActive = total / activeDays;
          const sd = usages
            .map((e) => new Date(e.date + "T00:00:00"))
            .sort((a, b) => a - b);
          calDays =
            usages.length >= 2
              ? Math.round((sd[sd.length - 1] - sd[0]) / 86400000) + 1
              : 1;
          avgCal = total / calDays;
          daysLeft =
            avgCal > 0 ? (h.remaining_stock / avgCal).toFixed(1) : null;
        }

        const maxQ = Math.max(...usages.map((e) => e.quantity), 1);
        const bars = usages
          .slice(-14)
          .map((e) => {
            const ht = Math.max(2, Math.round((e.quantity / maxQ) * 60));
            return `<div class="bar-col"><div class="bar" style="height:${ht}px;" title="${e.date}: ${e.quantity}"></div><div class="bar-lbl">${e.date.slice(5)}</div></div>`;
          })
          .join("");

        out.innerHTML = `
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.7rem;">
    <span style="font-weight:700;">${h.phase_name} <span class="sub">&middot; ${matName}</span></span>
    <span class="sub" style="font-size:.72rem;">${pct.toFixed(1)}% consumed</span>
  </div>
  <div class="prog"><div class="prog-fill" style="width:${pct}%;background:${fc};"></div></div>
  <div class="stats" style="margin-top:.7rem;margin-bottom:${usages.length ? ".7rem" : "0"};">
    <div class="stat"><div class="stat-label">Ordered</div><div class="stat-value">${h.ordered_qty.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Consumed</div><div class="stat-value warn">${h.consumed_qty.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Remaining</div><div class="stat-value good">${h.remaining_stock.toFixed(3)}</div></div>
  </div>
  ${
    usages.length
      ? `
  <hr>
  <div class="stats" style="margin-bottom:.55rem;">
    <div class="stat">
      <div class="stat-label">Avg / Active Day</div>
      <div class="stat-value">${avgActive.toFixed(2)}</div>
      <div class="sub" style="font-size:.65rem;">${activeDays} log${activeDays !== 1 ? "s" : ""}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Avg / Calendar Day</div>
      <div class="stat-value warn">${avgCal.toFixed(2)}</div>
      <div class="sub" style="font-size:.65rem;">${calDays}-day span</div>
    </div>
    ${
      daysLeft !== null
        ? `
    <div class="stat">
      <div class="stat-label">Est. Days Left</div>
      <div class="stat-value ${parseFloat(daysLeft) <= 3 ? "bad" : parseFloat(daysLeft) <= 7 ? "warn" : "good"}">${daysLeft}d</div>
      <div class="sub" style="font-size:.65rem;">at current rate</div>
    </div>`
        : ""
    }
  </div>
  <div class="bars">${bars}</div>
  <div class="tbl-wrap" style="margin-top:.45rem;"><table>
    <thead><tr><th>Date</th><th>Used</th><th>Running Total</th><th>Remaining</th></tr></thead>
    <tbody>${(() => {
      let run = 0;
      return usages
        .map((e) => {
          run += e.quantity;
          return `<tr><td>${e.date}</td><td>${e.quantity}</td><td>${run.toFixed(3)}</td><td>${Math.max(0, h.ordered_qty - run).toFixed(3)}</td></tr>`;
        })
        .join("");
    })()}</tbody>
  </table></div>`
      : `<div class="sub mt">No usage logged yet for this phase.</div>`
  }
</div>`;
      }

      async function logDailyUsage() {
        const mat = document.getElementById("p3-mat").value;
        const phaseI = parseInt(document.getElementById("p3-phase").value);
        const qty = parseFloat(document.getElementById("p3-qty").value);
        const dateV = document.getElementById("p3-date").value;
        if (isNaN(qty) || qty < 0)
          return toast("Enter a valid quantity.", "warn");
        if (isNaN(phaseI) || phaseI < 0)
          return toast("No phase selected.", "warn");
        try {
          const res = await api("POST", "/phase/log-daily-usage", {
            material: mat,
            phase_index: phaseI,
            qty_used: qty,
            date: dateV || undefined,
            // pass site coords if user has set them in the auto-reorder panel
            dest_lat: siteCoords ? siteCoords.lat : undefined,
            dest_lon: siteCoords ? siteCoords.lon : undefined,
            dest_name: siteCoords ? siteCoords.name : undefined,
          });
          await loadMaterials();
          loadPhases("p3");
          renderPhaseSnapshot();
          toast(`Logged ${qty} for ${mat}.`, "ok");

          // ‚îÄ‚îÄ Auto-reorder inline alert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ //
          renderAutoReorderAlert(
            res.auto_reorder,
            document.getElementById("p3-output"),
          );
        } catch (e) {
          toast(e.message, "err");
        }
      }

      // Site coordinates set by the user in the auto-reorder panel
      let siteCoords = null;

      function renderAutoReorderAlert(ar, container) {
        if (!ar) return;
        if (!ar.triggered) {
          // Show a quiet "stock OK" badge
          const days = ar.prediction && ar.prediction.days_remaining;
          if (days !== null && days !== undefined) {
            container.innerHTML = `
<div style="margin-top:.6rem;padding:.5rem .9rem;background:rgba(39,174,96,.1);
  border-left:3px solid var(--green);border-radius:var(--radius);font-size:.79rem;display:flex;gap:.6rem;align-items:center;">
  ‚úÖ <span>Stock OK ‚Äî <b style="color:var(--green);">${days.toFixed(1)} days</b> remaining (EMA rate: ${ar.prediction.ema_rate} ${ar.unit}/day)</span>
</div>`;
          }
          return;
        }

        const isCritical = ar.critical;
        const bg = isCritical ? "rgba(192,57,43,.12)" : "rgba(230,126,34,.1)";
        const border = isCritical ? "var(--red)" : "var(--amber)";
        const icon = isCritical ? "üö®" : "‚ö†Ô∏è";
        const pred = ar.prediction || {};

        let supplyHTML = "";
        if (ar.supply_plan && !ar.supply_plan.error) {
          const sp = ar.supply_plan;
          const sum = sp.summary || {};
          supplyHTML = `
<div style="margin-top:.75rem;padding:.65rem .9rem;background:var(--surface2);border-radius:var(--radius);">
  <div style="font-weight:700;font-size:.8rem;margin-bottom:.5rem;">üì¶ Auto Supply Plan Ready</div>
  <div class="stats">
    <div class="stat"><div class="stat-label">Trucks</div><div class="stat-value">${sum.total_trucks ?? "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Depots</div><div class="stat-value">${sum.depots_used ?? "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Stores</div><div class="stat-value">${sum.stores_sourced ?? "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Distance</div><div class="stat-value">${sum.total_km ? sum.total_km.toLocaleString() + " km" : "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">CO‚ÇÇ</div><div class="stat-value">${sum.total_co2_kg ? sum.total_co2_kg.toLocaleString() + " kg" : "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Shortfalls</div><div class="stat-value ${sum.shortfalls > 0 ? "bad" : "good"}">${sum.shortfalls ?? 0}</div></div>
  </div>
  ${(sp.depot_plans || [])
    .map(
      (dp) => `
    <div style="margin-top:.5rem;font-size:.76rem;color:var(--sub);font-weight:600;">${dp.depot.name}</div>
    ${(dp.assignments || [])
      .map(
        (a) => `
      <div style="font-size:.73rem;padding:.2rem 0;border-bottom:1px solid var(--border);">
        üöõ <b>${a.truck_id}</b> ‚Äî ${a.load_kg.toLocaleString()} kg ¬∑ ${a.distance_km} km
        <span style="color:var(--sub);">${a.route.map((r) => r.name).join(" ‚Üí ")}</span>
      </div>`,
      )
      .join("")}
  `,
    )
    .join("")}
  ${
    (sp.shortfalls || []).length
      ? `
    <div style="margin-top:.5rem;padding:.4rem .7rem;background:rgba(192,57,43,.1);border-radius:5px;font-size:.74rem;color:var(--red);">
      ‚ö† Shortfalls: ${sp.shortfalls.map((s) => `${s.material} (${s.shortfall_kg} kg)`).join(", ")}
    </div>`
      : ""
  }
</div>`;
        } else if (ar.supply_plan && ar.supply_plan.error) {
          supplyHTML = `<div style="font-size:.74rem;color:var(--sub);margin-top:.4rem;">Supply plan unavailable: ${ar.supply_plan.error}</div>`;
        } else if (!siteCoords) {
          supplyHTML = `<div style="font-size:.74rem;color:var(--sub);margin-top:.5rem;">
            üí° Set your <b>site location</b> in the Auto-Reorder panel below to get a full supply plan automatically.
          </div>`;
        }

        container.innerHTML = `
<div style="margin-top:.6rem;padding:.7rem .95rem;background:${bg};
  border-left:3px solid ${border};border-radius:var(--radius);font-size:.8rem;">
  <div style="font-weight:700;font-size:.84rem;margin-bottom:.3rem;">${icon} Auto-Reorder Alert ‚Äî ${ar.material}</div>
  <div style="color:var(--fg);margin-bottom:.3rem;">${ar.reason}</div>
  <div class="stats">
    <div class="stat"><div class="stat-label">EMA Rate</div><div class="stat-value">${pred.ema_rate ?? "‚Äî"} ${ar.unit}/day</div></div>
    <div class="stat"><div class="stat-label">Days Left</div><div class="stat-value ${isCritical ? "bad" : "warn"}">${pred.days_remaining != null ? pred.days_remaining.toFixed(1) : "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Stockout</div><div class="stat-value">${pred.stockout_date ?? "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Reorder Qty</div><div class="stat-value">${ar.reorder_qty} ${ar.unit}</div></div>
  </div>
  ${supplyHTML}
</div>`;
      }

      /* ‚îÄ‚îÄ Auto-Reorder site geocoding ‚îÄ‚îÄ */
      async function arGeoSearch() {
        const q = document.getElementById("ar-geo-input").value.trim();
        if (!q) return toast("Enter a site location.", "warn");
        const el = document.getElementById("ar-geo-results");
        el.innerHTML = `<div style="padding:.5rem .7rem;color:var(--sub);font-size:.8rem;">Searching‚Ä¶</div>`;
        el.style.display = "block";
        try {
          const data = await api("GET", `/geocode?q=${encodeURIComponent(q)}`);
          if (!data.length) {
            el.innerHTML = `<div style="padding:.5rem .7rem;color:var(--sub);font-size:.8rem;">No results.</div>`;
            return;
          }
          el._candidates = data;
          el.innerHTML = data
            .map(
              (c, i) => `
<div onclick="arSelectSite(${i})" style="padding:.42rem .7rem;cursor:pointer;font-size:.8rem;
  border-bottom:1px solid var(--border);"
  onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
  <b>${c.name}</b> <span class="sub" style="font-size:.72rem;">${c.display_name}</span>
</div>`,
            )
            .join("");
        } catch (e) {
          el.innerHTML = `<div style="padding:.5rem .7rem;color:var(--red);font-size:.8rem;">${e.message}</div>`;
        }
      }

      function arSelectSite(idx) {
        const c = document.getElementById("ar-geo-results")._candidates[idx];
        siteCoords = { lat: c.lat, lon: c.lon, name: c.name };
        document.getElementById("ar-geo-results").style.display = "none";
        document.getElementById("ar-geo-input").value = c.name;
        const badge = document.getElementById("ar-site-badge");
        document.getElementById("ar-site-label").textContent =
          `${c.name} (${c.lat.toFixed(4)}, ${c.lon.toFixed(4)})`;
        badge.style.display = "flex";
        toast(
          `Site set: ${c.name}. Auto-reorder is now active for all logs.`,
          "ok",
        );
      }

      function arClearSite() {
        siteCoords = null;
        document.getElementById("ar-geo-input").value = "";
        document.getElementById("ar-site-badge").style.display = "none";
        document.getElementById("ar-all-output").innerHTML = "";
      }

      async function runAllReorderCheck() {
        if (!siteCoords) return toast("Set a site location first.", "warn");
        const out = document.getElementById("ar-all-output");
        out.innerHTML = `<div class="sub" style="margin-top:.6rem;font-size:.79rem;">Running EMA predictions across all materials‚Ä¶</div>`;
        try {
          const res = await api("POST", "/phase/auto-reorder-all", {
            dest_lat: siteCoords.lat,
            dest_lon: siteCoords.lon,
            dest_name: siteCoords.name,
          });

          const {
            alerts,
            triggered_count,
            critical_count,
            combined_supply_plan: csp,
          } = res;

          const triggered = alerts.filter((a) => a.triggered);
          const ok = alerts.filter(
            (a) => !a.triggered && !a.prediction?.insufficient_data,
          );
          const nodata = alerts.filter((a) => a.prediction?.insufficient_data);

          let html = `<div style="margin-top:.75rem;">`;

          // Summary bar
          html += `<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.6rem;">
            <span style="font-size:.76rem;padding:.2rem .6rem;border-radius:99px;
              background:${critical_count > 0 ? "rgba(192,57,43,.15)" : "rgba(39,174,96,.1)"};
              color:${critical_count > 0 ? "var(--red)" : "var(--green)"};">
              ${critical_count > 0 ? `üö® ${critical_count} Critical` : "‚úÖ No Critical Alerts"}
            </span>
            ${triggered_count > 0 ? `<span style="font-size:.76rem;padding:.2rem .6rem;border-radius:99px;background:rgba(230,126,34,.1);color:var(--amber);">‚ö† ${triggered_count} Reorder Needed</span>` : ""}
            <span style="font-size:.76rem;padding:.2rem .6rem;border-radius:99px;background:var(--surface2);color:var(--sub);">${ok.length} Materials OK</span>
          </div>`;

          // Triggered alerts
          triggered.forEach((ar) => {
            const isCrit = ar.critical;
            const pred = ar.prediction || {};
            html += `
<div style="margin-bottom:.5rem;padding:.6rem .9rem;
  background:${isCrit ? "rgba(192,57,43,.1)" : "rgba(230,126,34,.08)"};
  border-left:3px solid ${isCrit ? "var(--red)" : "var(--amber)"};
  border-radius:var(--radius);font-size:.78rem;">
  <b>${isCrit ? "üö®" : "‚ö†Ô∏è"} ${ar.material}</b> ‚Äî ${pred.days_remaining != null ? pred.days_remaining.toFixed(1) + " days left" : "low stock"}
  <span class="sub" style="font-size:.72rem;display:block;margin-top:.2rem;">
    EMA: ${pred.ema_rate ?? "‚Äî"} ${ar.unit}/day ¬∑ Stockout: ${pred.stockout_date ?? "‚Äî"} ¬∑ Reorder: ${ar.reorder_qty} ${ar.unit}
  </span>
</div>`;
          });

          // Combined supply plan
          if (csp && !csp.error) {
            const sum = csp.summary || {};
            html += `<div style="margin-top:.7rem;padding:.65rem .9rem;background:var(--surface2);border-radius:var(--radius);">
  <div style="font-weight:700;font-size:.8rem;margin-bottom:.45rem;">üì¶ Combined Supply Plan (All Triggered Materials)</div>
  <div class="stats">
    <div class="stat"><div class="stat-label">Trucks</div><div class="stat-value">${sum.total_trucks ?? "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Depots</div><div class="stat-value">${sum.depots_used ?? "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Total kg</div><div class="stat-value">${sum.total_kg ? sum.total_kg.toLocaleString() : "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Distance</div><div class="stat-value">${sum.total_km ? sum.total_km.toLocaleString() + " km" : "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">CO‚ÇÇ</div><div class="stat-value">${sum.total_co2_kg ? sum.total_co2_kg.toLocaleString() + " kg" : "‚Äî"}</div></div>
  </div>
  ${(csp.depot_plans || [])
    .map(
      (dp) => `
    <div style="margin-top:.5rem;font-size:.75rem;font-weight:600;color:var(--sub);">${dp.depot.name}</div>
    ${(dp.assignments || [])
      .map(
        (a) => `
      <div style="font-size:.72rem;padding:.18rem 0;border-bottom:1px solid var(--border);">
        üöõ <b>${a.truck_id}</b> ‚Äî ${a.load_kg.toLocaleString()} kg ¬∑ ${a.distance_km} km
        <span style="color:var(--sub);">${a.route.map((r) => r.name).join(" ‚Üí ")}</span>
      </div>`,
      )
      .join("")}
  `,
    )
    .join("")}
</div>`;
          } else if (triggered_count === 0) {
            html += `<div style="font-size:.78rem;color:var(--green);margin-top:.5rem;">‚úÖ All materials are sufficiently stocked ‚Äî no reorder needed.</div>`;
          }

          html += `</div>`;
          out.innerHTML = html;
        } catch (e) {
          out.innerHTML = `<div style="color:var(--red);font-size:.79rem;margin-top:.5rem;">Error: ${e.message}</div>`;
        }
      }

      /* ‚îÄ‚îÄ Reorder Transaction Log ‚îÄ‚îÄ */
      async function loadReorderLogs() {
        const out = document.getElementById("reorder-log-output");
        out.innerHTML = `<div class="sub" style="text-align:center;padding:1rem;">Loading‚Ä¶</div>`;
        try {
          const res = await fetch("/api/reorder-logs");
          const data = await res.json();
          const logs = data.logs || [];
          if (!logs.length) {
            out.innerHTML = `<div class="sub" style="text-align:center;padding:1.2rem 0;">No reorder events recorded yet.<br><span style="font-size:.72rem;">Events appear here automatically when stock falls below the reorder threshold.</span></div>`;
            return;
          }
          let html = `
<table style="width:100%;border-collapse:collapse;font-size:.76rem;">
  <thead>
    <tr style="text-align:left;border-bottom:2px solid var(--border);color:var(--sub);font-size:.72rem;">
      <th style="padding:.35rem .5rem;">#</th>
      <th style="padding:.35rem .5rem;">Timestamp (UTC)</th>
      <th style="padding:.35rem .5rem;">Material</th>
      <th style="padding:.35rem .5rem;">Qty Ordered</th>
      <th style="padding:.35rem .5rem;">Days Left</th>
      <th style="padding:.35rem .5rem;">Stockout</th>
      <th style="padding:.35rem .5rem;">EMA Rate</th>
      <th style="padding:.35rem .5rem;">Site</th>
      <th style="padding:.35rem .5rem;">Source</th>
      <th style="padding:.35rem .5rem;">Status</th>
    </tr>
  </thead>
  <tbody>`;
          logs.forEach((lg, i) => {
            const isCrit = lg.critical;
            const rowBg = isCrit
              ? "rgba(192,57,43,.07)"
              : i % 2 === 0
                ? "transparent"
                : "rgba(255,255,255,.02)";
            const badge = isCrit
              ? `<span style="background:rgba(192,57,43,.15);color:var(--red);padding:.1rem .4rem;border-radius:99px;font-size:.68rem;">üö® Critical</span>`
              : `<span style="background:rgba(230,126,34,.12);color:var(--amber);padding:.1rem .4rem;border-radius:99px;font-size:.68rem;">‚ö† Triggered</span>`;
            const srcBadge =
              lg.source === "batch-check"
                ? `<span style="background:rgba(99,102,241,.12);color:#818cf8;padding:.1rem .4rem;border-radius:99px;font-size:.67rem;">Batch</span>`
                : `<span style="background:rgba(20,184,166,.1);color:#2dd4bf;padding:.1rem .4rem;border-radius:99px;font-size:.67rem;">Daily Log</span>`;
            const ts = lg.timestamp
              ? lg.timestamp.replace("T", " ").replace("Z", "")
              : "‚Äî";
            html += `
    <tr style="background:${rowBg};border-bottom:1px solid var(--border);">
      <td style="padding:.38rem .5rem;color:var(--sub);">${lg.id}</td>
      <td style="padding:.38rem .5rem;white-space:nowrap;">${ts}</td>
      <td style="padding:.38rem .5rem;font-weight:600;">${lg.material}</td>
      <td style="padding:.38rem .5rem;">${lg.reorder_qty != null ? lg.reorder_qty.toLocaleString() : "‚Äî"} <span style="color:var(--sub);">${lg.unit || ""}</span></td>
      <td style="padding:.38rem .5rem;">${lg.days_remaining != null ? lg.days_remaining.toFixed(1) + "d" : "‚Äî"}</td>
      <td style="padding:.38rem .5rem;">${lg.stockout_date || "‚Äî"}</td>
      <td style="padding:.38rem .5rem;">${lg.ema_rate != null ? lg.ema_rate.toFixed(2) : "‚Äî"} ${lg.unit || ""}/day</td>
      <td style="padding:.38rem .5rem;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${lg.dest_name || "‚Äî"}</td>
      <td style="padding:.38rem .5rem;">${srcBadge}</td>
      <td style="padding:.38rem .5rem;">${badge}</td>
    </tr>`;
          });
          html += `</tbody></table>
<div class="sub" style="font-size:.71rem;margin-top:.55rem;text-align:right;">${data.total} total event${data.total !== 1 ? "s" : ""}</div>`;
          out.innerHTML = html;
        } catch (e) {
          out.innerHTML = `<div style="color:var(--red);font-size:.79rem;">Error loading logs: ${e.message}</div>`;
        }
      }

      async function clearReorderLogs() {
        if (!confirm("Clear ALL reorder log entries? This cannot be undone."))
          return;
        try {
          await fetch("/api/reorder-logs", { method: "DELETE" });
          toast("Reorder log cleared.", "success");
          loadReorderLogs();
        } catch (e) {
          toast("Failed to clear logs: " + e.message, "error");
        }
      }

      async function inventoryStatus() {
        const ordered = parseFloat(document.getElementById("p3-ordered").value);
        const consumed = parseFloat(
          document.getElementById("p3-consumed").value,
        );
        const carryin =
          parseFloat(document.getElementById("p3-carryin").value) || 0;
        if (isNaN(ordered) || isNaN(consumed))
          return toast("Fill in ordered and consumed.", "warn");
        const r = await api("POST", "/phase/inventory-status", {
          ordered_qty: ordered,
          consumed_qty: consumed,
          carry_in: carryin,
        });
        const pct = r.utilization_pct;
        const fc =
          pct >= 90
            ? "var(--red)"
            : pct >= 65
              ? "var(--amber)"
              : "var(--green)";
        document.getElementById("p3-manual").innerHTML = `
<div style="margin-top:.75rem;">
  <div class="prog"><div class="prog-fill" style="width:${pct}%;background:${fc};"></div></div>
  <div class="stats" style="margin-top:.55rem;">
    <div class="stat"><div class="stat-label">Total Available</div><div class="stat-value">${r.total_available.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Used</div><div class="stat-value warn">${r.used.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Remaining</div><div class="stat-value good">${r.remaining.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Utilisation</div><div class="stat-value ${pct >= 90 ? "bad" : pct >= 65 ? "warn" : "good"}">${pct.toFixed(1)}%</div></div>
  </div>
</div>`;
      }

      /* Forecast */
      async function runForecast() {
        const mat = document.getElementById("p3-mat").value;
        const phaseI = parseInt(document.getElementById("p3-phase").value);
        const horizon =
          parseInt(document.getElementById("p3-fc-horizon").value) || 14;
        if (isNaN(phaseI) || phaseI < 0)
          return toast("Select a phase first.", "warn");
        const out = document.getElementById("p3-fc-output");
        out.innerHTML = `<div class="sub">Running forecast‚Ä¶</div>`;
        try {
          const r = await api("POST", "/phase/forecast", {
            material: mat,
            phase_index: phaseI,
            horizon,
          });

          // colour helpers
          const excessColour = r.expected_excess >= 0 ? "good" : "bad";
          const mapeColour =
            r.backtest_mape === null
              ? ""
              : r.backtest_mape < 15
                ? "good"
                : r.backtest_mape < 25
                  ? "warn"
                  : "bad";
          const regimeBadge =
            r.regime === "ARIMA"
              ? `<span style="background:rgba(79,142,247,.15);color:var(--accent);font-size:.67rem;padding:.15rem .45rem;border-radius:5px;font-weight:700;">ARIMA</span>`
              : `<span style="background:rgba(251,191,36,.1);color:var(--amber);font-size:.67rem;padding:.15rem .45rem;border-radius:5px;font-weight:700;">MA</span>`;

          // mini bar chart for forecast
          const maxQ = Math.max(...r.forecast.map((f) => f.qty), 0.001);
          const bars = r.forecast
            .map((f) => {
              const ht = Math.max(2, Math.round((f.qty / maxQ) * 60));
              return `<div class="bar-col"><div class="bar" style="height:${ht}px;background:var(--accent);opacity:.7;" title="${f.date}: ${f.qty}"></div><div class="bar-lbl">${f.date.slice(5)}</div></div>`;
            })
            .join("");

          out.innerHTML = `
<div style="margin-top:.15rem;">
  ${r.warning ? `<div class="banner b-warn" style="margin-bottom:.7rem;">‚ö† ${r.warning}</div>` : ""}
  <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.7rem;flex-wrap:wrap;">
    ${regimeBadge}
    <span style="font-weight:600;font-size:.82rem;">${r.model}</span>
    <span class="sub" style="font-size:.72rem;">${r.note}</span>
  </div>
  <div class="stats" style="margin-bottom:.7rem;">
    <div class="stat">
      <div class="stat-label">Forecast Total</div>
      <div class="stat-value warn">${r.total_forecast.toFixed(3)}</div>
      <div class="sub" style="font-size:.65rem;">next ${r.horizon} days</div>
    </div>
    <div class="stat">
      <div class="stat-label">Expected ${r.expected_excess >= 0 ? "Surplus" : "Shortfall"}</div>
      <div class="stat-value ${excessColour}">${r.expected_excess >= 0 ? "+" : ""}${r.expected_excess.toFixed(3)}</div>
      <div class="sub" style="font-size:.65rem;">ordered ‚àí consumed ‚àí forecast</div>
    </div>
    ${
      r.backtest_mape !== null
        ? `
    <div class="stat">
      <div class="stat-label">Backtest MAPE</div>
      <div class="stat-value ${mapeColour}">${r.backtest_mape.toFixed(1)}%</div>
      <div class="sub" style="font-size:.65rem;">rolling-origin error</div>
    </div>`
        : ""
    }
    <div class="stat">
      <div class="stat-label">Data</div>
      <div class="stat-value">${r.data_available.log_entries}</div>
      <div class="sub" style="font-size:.65rem;">${r.data_available.calendar_days ?? "?"} cal. days</div>
    </div>
  </div>
  <div class="bars">${bars}</div>
  <div class="tbl-wrap" style="margin-top:.45rem;"><table>
    <thead><tr><th>Date</th><th>Forecast Qty</th></tr></thead>
    <tbody>${r.forecast.map((f) => `<tr><td>${f.date}</td><td>${f.qty.toFixed(4)}</td></tr>`).join("")}</tbody>
  </table></div>
</div>`;
        } catch (e) {
          out.innerHTML = `<div class="banner b-err">‚ö† ${e.message}</div>`;
        }
      }

      /* Reorder */
      async function reorderCheck() {
        const mat = document.getElementById("p4-mat").value;
        const ord = parseFloat(document.getElementById("p4-ordered").value);
        const rem = parseFloat(document.getElementById("p4-remaining").value);
        const plan = parseFloat(document.getElementById("p4-planned").value);
        if ([ord, rem, plan].some(isNaN))
          return toast("Fill in all fields.", "warn");
        const r = await api("POST", "/phase/reorder-check", {
          material: mat,
          ordered_qty: ord,
          remaining: rem,
          planned_qty: plan,
        });
        const remPct = ((r.remaining / ord) * 100).toFixed(1);
        const fc = r.alert ? "var(--red)" : "var(--green)";
        document.getElementById("p4-output").innerHTML = `
<div class="card">
  <div class="banner ${r.alert ? "b-warn" : "b-ok"}">
    ${r.alert ? `‚ö† Reorder needed ‚Äî stock critically low for <strong>${r.material}</strong>` : `‚úì Stock sufficient for <strong>${r.material}</strong>`}
  </div>
  <div class="prog"><div class="prog-fill" style="width:${remPct}%;background:${fc};"></div></div>
  <div class="sub" style="margin-bottom:.7rem;">${remPct}% of original order remaining</div>
  <div class="stats">
    <div class="stat"><div class="stat-label">Remaining</div><div class="stat-value ${r.alert ? "bad" : "good"}">${r.remaining.toFixed(3)} ${r.unit}</div></div>
    <div class="stat"><div class="stat-label">Threshold (20%)</div><div class="stat-value warn">${r.threshold_qty.toFixed(3)} ${r.unit}</div></div>
    ${r.alert ? `<div class="stat"><div class="stat-label">Suggested Reorder</div><div class="stat-value">${r.suggested_reorder_qty.toFixed(3)} ${r.unit}</div></div>` : ""}
  </div>
</div>`;
      }

      /* Close Phase */
      async function completePhase() {
        const mat = document.getElementById("p5-mat").value;
        const phase = document.getElementById("p5-phase").value.trim();
        const planned = parseFloat(document.getElementById("p5-planned").value);
        const ordered = parseFloat(document.getElementById("p5-ordered").value);
        const consumed = parseFloat(
          document.getElementById("p5-consumed").value,
        );
        const carryin =
          parseFloat(document.getElementById("p5-carryin").value) || 0;
        if (!phase) return toast("Enter a phase name.", "warn");
        if ([planned, ordered, consumed].some(isNaN))
          return toast("Fill in all qty fields.", "warn");
        try {
          const r = await api("POST", "/phase/complete", {
            material: mat,
            phase_name: phase,
            planned_qty: planned,
            ordered_qty: ordered,
            consumed_qty: consumed,
            carry_in: carryin,
          });
          await loadMaterials();
          loadPhases("p3");
          const dir = r.waste_pct >= 0 ? "over-ordered" : "under-ordered";
          const wc =
            Math.abs(r.waste_pct) < 5
              ? "good"
              : r.waste_pct > 0
                ? "warn"
                : "bad";
          document.getElementById("p5-output").innerHTML = `
<div class="card">
  <div class="banner b-ok">‚úì <strong>${r.phase_name}</strong> closed for <strong>${r.material}</strong></div>
  <div class="stats">
    <div class="stat"><div class="stat-label">Planned</div><div class="stat-value">${r.planned_qty.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Ordered</div><div class="stat-value">${r.ordered_qty.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Consumed</div><div class="stat-value">${r.consumed_qty.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Remaining</div><div class="stat-value good">${r.remaining_stock.toFixed(3)}</div></div>
    <div class="stat"><div class="stat-label">Waste</div><div class="stat-value ${wc}">${r.waste_pct >= 0 ? "+" : ""}${r.waste_pct.toFixed(2)}%</div></div>
    <div class="stat"><div class="stat-label">New Buffer</div><div class="stat-value warn">${r.new_buffer_pct.toFixed(2)}%</div></div>
  </div>
  <div class="sub mt">${dir.charAt(0).toUpperCase() + dir.slice(1)} by ${Math.abs(r.waste_pct).toFixed(2)}% &middot; Buffer ${r.baseline_buffer.toFixed(2)}% &rarr; ${r.new_buffer_pct.toFixed(2)}% &middot; ${r.phases_logged} phases total</div>
</div>`;
          toast("Phase closed. Buffer updated.", "ok");
        } catch (e) {
          toast(e.message, "err");
        }
      }

      async function loadHistory() {
        const mat = document.getElementById("p5-mat").value;
        const m = matByName(mat);
        const out = document.getElementById("p5-history");
        if (!m || !m.history.length) {
          out.innerHTML = `<div class="card"><div class="sub">No history for ${mat}.</div></div>`;
          return;
        }
        let totalOrd = 0,
          totalCons = 0;
        const rows = m.history
          .map((h, i) => {
            totalOrd += h.ordered_qty;
            totalCons += h.consumed_qty;
            const wc =
              Math.abs(h.waste_pct) < 5
                ? "good"
                : h.waste_pct > 0
                  ? "warn"
                  : "bad";
            return `<tr>
<td class="sub">${i + 1}</td>
<td><strong>${h.phase_name}</strong></td>
<td>${h.planned_qty.toFixed(3)}</td>
<td>${h.ordered_qty.toFixed(3)}</td>
<td>${h.consumed_qty.toFixed(3)}</td>
<td>${h.remaining_stock.toFixed(3)}</td>
<td class="${wc}">${h.waste_pct >= 0 ? "+" : ""}${h.waste_pct.toFixed(2)}%</td>
<td class="sub">${(h.daily_usage || []).length}</td>
</tr>`;
          })
          .join("");
        const ow =
          totalOrd > 0
            ? (((totalOrd - totalCons) / totalOrd) * 100).toFixed(2)
            : 0;
        out.innerHTML = `
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem;">
    <div style="font-weight:700;">${m.name} ‚Äî History</div>
    <div class="sub">Buffer ${m.baseline_buffer_pct.toFixed(2)}% &rarr; ${m.buffer_pct.toFixed(2)}%</div>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>#</th><th>Phase</th><th>Planned</th><th>Ordered</th><th>Consumed</th><th>Remaining</th><th>Waste</th><th>Logs</th></tr></thead>
    <tbody>${rows}</tbody>
    <tfoot><tr style="font-weight:700;border-top:2px solid var(--border);">
      <td colspan="2">Totals</td><td>‚Äî</td>
      <td>${totalOrd.toFixed(3)}</td><td>${totalCons.toFixed(3)}</td><td>‚Äî</td>
      <td class="${+ow >= 0 ? "warn" : "bad"}">${+ow >= 0 ? "+" : ""}${ow}%</td><td>‚Äî</td>
    </tr></tfoot>
  </table></div>
</div>`;
      }

      /* ‚îÄ‚îÄ‚îÄ Delivery ‚îÄ‚îÄ‚îÄ */
      let truckCount = 0;
      let deliveryMap = null;
      let mapMarkers = []; // all Leaflet markers currently on map
      let mapPolylines = []; // all Leaflet polylines currently on map

      /* ‚îÄ‚îÄ Route Builder state ‚îÄ‚îÄ */
      let routeStops = []; // [{name, lat, lon, role:'source'|'stop'|'dest'}]
      let pendingPlace = null; // {name, lat, lon} ‚Äî last geocode candidate selected
      let previewMarker = null; // single Leaflet marker for geocode preview

      function buildDeliveryMatRows() {
        document.getElementById("d-mat-rows").innerHTML = materials
          .map(
            (m) => `
<div class="row" style="margin-bottom:.38rem;">
  <div class="field" style="max-width:155px;flex:none;">
    <label style="font-weight:600;">${m.name}</label>
    <div class="sub" style="font-size:.68rem;">${m.unit} &middot; ${m.weight_per_unit}kg/unit</div>
  </div>
  <div class="field" style="max-width:125px;">
    <label>Dispatch Qty</label>
    <input id="d-qty-${m.name}" type="number" value="0" min="0" step="any"/>
  </div>
</div>`,
          )
          .join("");
      }

      function addTruck() {
        truckCount++;
        const div = document.createElement("div");
        div.className = "truck-entry";
        div.id = `truck-${truckCount}`;
        div.innerHTML = `
<div class="field" style="max-width:145px;"><label>Truck ID</label><input class="t-id" value="TRK-0${truckCount}"/></div>
<div class="field" style="max-width:135px;"><label>Capacity (kg)</label><input class="t-cap" type="number" value="10000" min="1"/></div>
<button class="btn btn-ghost" style="padding:.38rem;" onclick="this.parentElement.remove()">‚úï</button>`;
        document.getElementById("d-trucks").appendChild(div);
      }

      /* ‚îÄ‚îÄ Map helpers ‚îÄ‚îÄ */
      function initDeliveryMap() {
        if (deliveryMap) return;
        deliveryMap = L.map("delivery-map").setView([20.5937, 78.9629], 5);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
          maxZoom: 19,
        }).addTo(deliveryMap);
      }

      function clearMapLayers() {
        mapMarkers.forEach((m) => deliveryMap.removeLayer(m));
        mapPolylines.forEach((p) => deliveryMap.removeLayer(p));
        mapMarkers = [];
        mapPolylines = [];
      }

      /* ‚îÄ‚îÄ Geocoding ‚îÄ‚îÄ */
      async function geocodeSearch() {
        const q = document.getElementById("geo-input").value.trim();
        if (!q) return toast("Enter a place name to search.", "warn");
        const resultsEl = document.getElementById("geo-results");
        resultsEl.innerHTML = `<div style="padding:.5rem .7rem;color:var(--sub);font-size:.8rem;">Searching‚Ä¶</div>`;
        resultsEl.style.display = "block";
        try {
          const data = await api("GET", `/geocode?q=${encodeURIComponent(q)}`);
          if (!data.length) {
            resultsEl.innerHTML = `<div style="padding:.5rem .7rem;color:var(--sub);font-size:.8rem;">No results found.</div>`;
            return;
          }
          resultsEl.innerHTML = data
            .map(
              (c, i) => `
<div onclick="selectGeocandidate(${i})" style="
  padding:.45rem .7rem;cursor:pointer;font-size:.8rem;
  border-bottom:1px solid var(--border);
  transition:background .15s;"
  onmouseover="this.style.background='var(--surface2)'"
  onmouseout="this.style.background=''">
  <span style="font-weight:600;">${c.name}</span>
  <span class="sub" style="font-size:.72rem;margin-left:.4rem;">${c.display_name}</span>
</div>`,
            )
            .join("");
          /* store candidates for selectGeocandidate */
          resultsEl._candidates = data;
        } catch (e) {
          resultsEl.innerHTML = `<div style="padding:.5rem .7rem;color:var(--red);font-size:.8rem;">Error: ${e.message}</div>`;
        }
      }

      function selectGeocandidate(idx) {
        const c = document.getElementById("geo-results")._candidates[idx];
        pendingPlace = { name: c.name, lat: c.lat, lon: c.lon };
        document.getElementById("geo-results").style.display = "none";
        document.getElementById("geo-input").value = c.name;

        /* preview marker on map */
        if (!deliveryMap) initDeliveryMap();
        if (previewMarker) deliveryMap.removeLayer(previewMarker);
        previewMarker = L.marker([c.lat, c.lon], {
          icon: L.divIcon({
            className: "",
            html: `<div style="
              background:#8e44ad;
              width:26px;height:26px;
              border-radius:50%;
              border:3px solid #fff;
              box-shadow:0 2px 8px rgba(0,0,0,.5);
              display:flex;align-items:center;justify-content:center;
              color:#fff;font-size:14px;font-weight:800;
            ">?</div>
            <div style="
              margin-top:2px;background:#8e44ad;color:#fff;
              font-size:9px;font-weight:700;padding:1px 4px;
              border-radius:3px;white-space:nowrap;
              box-shadow:0 1px 4px rgba(0,0,0,.4);font-family:sans-serif;
              max-width:90px;overflow:hidden;text-overflow:ellipsis;
            ">${c.name}</div>`,
            iconSize: [26, 44],
            iconAnchor: [13, 13],
          }),
        })
          .addTo(deliveryMap)
          .bindPopup(
            `<div style="font-size:12px;"><b>${c.name}</b><br/><span style="color:#666;">${c.lat.toFixed(4)}, ${c.lon.toFixed(4)}</span><br/><span style="color:#8e44ad;font-size:11px;">Click a role button to add</span></div>`,
          )
          .openPopup();
        deliveryMap.setView([c.lat, c.lon], Math.max(deliveryMap.getZoom(), 8));

        /* show action buttons hint */
        toast(
          `"${c.name}" selected ‚Äî set it as Source, Stop, or Destination.`,
          "info",
        );
      }

      function addPendingAsStop(role) {
        if (!pendingPlace)
          return toast("Search and select a location first.", "warn");

        /* enforce single source / destination */
        if (role === "source" && routeStops.some((s) => s.role === "source")) {
          routeStops = routeStops.filter((s) => s.role !== "source");
        }
        if (role === "dest" && routeStops.some((s) => s.role === "dest")) {
          routeStops = routeStops.filter((s) => s.role !== "dest");
        }

        routeStops.push({ ...pendingPlace, role });
        pendingPlace = null;
        if (previewMarker) {
          deliveryMap.removeLayer(previewMarker);
          previewMarker = null;
        }
        document.getElementById("geo-input").value = "";
        renderStopsList();
        drawRoutePreview();
      }

      function removeStop(idx) {
        routeStops.splice(idx, 1);
        renderStopsList();
        drawRoutePreview();
      }

      const roleBadge = {
        source: ["üü¢", "#27ae60", "Source / Depot"],
        stop: ["üîµ", "#2980b9", "Stop"],
        dest: ["üî¥", "#c0392b", "Destination"],
      };

      function renderStopsList() {
        const el = document.getElementById("route-stops");
        if (!routeStops.length) {
          el.innerHTML = "";
          updateRouteSummary();
          return;
        }

        /* sort: source first, then stops, then dest */
        const order = { source: 0, stop: 1, dest: 2 };
        const sorted = [...routeStops].sort(
          (a, b) => order[a.role] - order[b.role],
        );
        routeStops = sorted;

        el.innerHTML = routeStops
          .map((s, i) => {
            const [, col, label] = roleBadge[s.role];
            return `
<div style="display:flex;align-items:center;gap:.5rem;padding:.38rem .6rem;border-radius:6px;background:var(--surface2);font-size:.79rem;border-left:3px solid ${col};">
  <div class="stop-dot" style="background:${col};"></div>
  <span style="flex:1;font-weight:600;">${s.name}</span>
  <span style="color:${col};font-size:.69rem;font-weight:700;text-transform:uppercase;letter-spacing:.03em;">${label}</span>
  <span style="color:var(--sub);font-size:.67rem;">${s.lat.toFixed(3)}, ${s.lon.toFixed(3)}</span>
  <button onclick="removeStop(${i})" style="background:none;border:none;color:var(--sub);cursor:pointer;font-size:.9rem;padding:0 .2rem;">‚úï</button>
</div>`;
          })
          .join("");
        updateRouteSummary();
      }

      function updateRouteSummary() {
        const el = document.getElementById("route-summary");
        const src = routeStops.find((s) => s.role === "source");
        const dest = routeStops.find((s) => s.role === "dest");
        const stops = routeStops.filter((s) => s.role === "stop");
        if (!src && !dest) {
          el.textContent = "";
          return;
        }
        el.textContent = `${src ? src.name : "?"} ‚Üí ${stops.map((s) => s.name).join(" ‚Üí ")}${stops.length ? " ‚Üí " : ""} ${dest ? dest.name : "?"}`;
      }

      function drawRoutePreview() {
        if (!deliveryMap) initDeliveryMap();
        clearMapLayers();
        if (routeStops.length < 2) return;

        const order = { source: 0, stop: 1, dest: 2 };
        const sorted = [...routeStops].sort(
          (a, b) => order[a.role] - order[b.role],
        );
        const coords = sorted.map((s) => [s.lat, s.lon]);

        /* dashed preview polyline */
        const poly = L.polyline(coords, {
          color: "#7f8c8d",
          weight: 2,
          dashArray: "7 5",
          opacity: 0.6,
        }).addTo(deliveryMap);
        mapPolylines.push(poly);

        const bounds = L.latLngBounds();
        sorted.forEach((s, i) => {
          const [, col, label] = roleBadge[s.role];
          /* larger pin for source/dest, medium for stops */
          const isEndpoint = s.role === "source" || s.role === "dest";
          const sz = isEndpoint ? 32 : 24;
          const marker = L.marker([s.lat, s.lon], {
            icon: L.divIcon({
              className: "",
              html: `<div style="
                background:${col};
                width:${sz}px;height:${sz}px;
                border-radius:50%;
                border:3px solid #fff;
                box-shadow:0 2px 8px rgba(0,0,0,.55);
                display:flex;align-items:center;justify-content:center;
                color:#fff;font-size:${isEndpoint ? 13 : 11}px;font-weight:800;
                font-family:sans-serif;
              ">${i + 1}</div>
              <div style="
                margin-top:2px;
                background:${col};
                color:#fff;
                font-size:9px;font-weight:700;
                padding:1px 4px;border-radius:3px;
                white-space:nowrap;
                box-shadow:0 1px 4px rgba(0,0,0,.4);
                font-family:sans-serif;
                max-width:90px;overflow:hidden;text-overflow:ellipsis;
              ">${s.name}</div>`,
              iconSize: [sz, sz + 18],
              iconAnchor: [sz / 2, sz / 2],
            }),
          }).addTo(deliveryMap).bindPopup(`
              <div style="font-size:12px;min-width:140px;">
                <div style="color:${col};font-weight:700;font-size:13px;margin-bottom:3px;">${s.name}</div>
                <div style="color:#666;">${label}</div>
                <div style="color:#999;font-size:11px;margin-top:3px;">${s.lat.toFixed(4)}, ${s.lon.toFixed(4)}</div>
              </div>`);
          mapMarkers.push(marker);
          bounds.extend([s.lat, s.lon]);
        });
        deliveryMap.fitBounds(bounds, { padding: [60, 60] });
      }

      function clearRoute() {
        routeStops = [];
        pendingPlace = null;
        if (previewMarker && deliveryMap) {
          deliveryMap.removeLayer(previewMarker);
          previewMarker = null;
        }
        document.getElementById("geo-input").value = "";
        document.getElementById("geo-results").style.display = "none";
        renderStopsList();
        if (deliveryMap) clearMapLayers();
        document.getElementById("d-output").innerHTML = "";
      }

      /* ‚îÄ‚îÄ Results map ‚îÄ‚îÄ */
      function displayTrucksOnMap(results, stopCoords) {
        if (!deliveryMap) initDeliveryMap();
        clearMapLayers();

        const colors = [
          "#e74c3c",
          "#2ecc71",
          "#3498db",
          "#e67e22",
          "#9b59b6",
          "#1abc9c",
          "#f39c12",
          "#e91e63",
        ];
        const bounds = L.latLngBounds();

        results.forEach((truck, idx) => {
          const color = colors[idx % colors.length];
          const route = truck.route || [];

          /* look up coordinates from stopCoords first, then routeStops fallback */
          const routeCoords = route
            .map((loc) => {
              if (stopCoords && stopCoords[loc])
                return [stopCoords[loc].lat, stopCoords[loc].lon];
              const rs = routeStops.find((s) => s.name === loc);
              return rs ? [rs.lat, rs.lon] : null;
            })
            .filter(Boolean);

          if (!routeCoords.length) return;

          const poly = L.polyline(routeCoords, {
            color,
            weight: 3.5,
            opacity: 0.85,
          }).addTo(deliveryMap);
          mapPolylines.push(poly);

          routeCoords.forEach((coord, si) => {
            const isDepot = si === 0 || si === routeCoords.length - 1;
            const sz = isDepot ? 26 : 18;
            const icon = L.divIcon({
              className: "",
              html: `<div style="background:${color};width:${sz}px;height:${sz}px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;color:#fff;font-size:${isDepot ? 12 : 10}px;font-weight:700;">${isDepot ? "üè†" : si}</div>`,
              iconSize: [sz, sz],
              iconAnchor: [sz / 2, sz / 2],
            });
            const m = L.marker(coord, { icon }).addTo(deliveryMap).bindPopup(`
<div style="font-size:11px;min-width:170px;">
  <strong style="color:${color};font-size:13px;">üöõ ${truck.truck_id}</strong><br/>
  <b>Stop:</b> ${route[si]}<br/>
  <b>Leg:</b> ${si + 1} / ${routeCoords.length}<br/>
  <hr style="margin:4px 0;border:none;border-top:1px solid #eee;">
  <b>Load:</b> ${truck.used_kg.toLocaleString()} kg<br/>
  <b>Capacity:</b> ${truck.capacity_kg.toLocaleString()} kg<br/>
  <b>Util.:</b> ${truck.utilization_pct.toFixed(1)}%<br/>
  <b>Distance:</b> ${truck.distance_km.toFixed(1)} km<br/>
  <b>CO‚ÇÇ:</b> ${truck.co2_kg.toLocaleString()} kg
</div>`);
            mapMarkers.push(m);
            bounds.extend(coord);
          });
        });

        if (mapMarkers.length)
          deliveryMap.fitBounds(bounds, { padding: [50, 50] });
      }

      /* ‚îÄ‚îÄ Plan delivery ‚îÄ‚îÄ */
      async function planDelivery() {
        /* validate route */
        const src = routeStops.find((s) => s.role === "source");
        const dest = routeStops.find((s) => s.role === "dest");
        if (!src)
          return toast("Set a Source (depot) on the Route Builder.", "warn");
        if (!dest)
          return toast("Set a Destination on the Route Builder.", "warn");

        /* quantities */
        const oq = {};
        materials.forEach((m) => {
          const v =
            parseFloat(document.getElementById(`d-qty-${m.name}`)?.value) || 0;
          if (v > 0) oq[m.name] = v;
        });
        if (!Object.keys(oq).length)
          return toast("Add at least one dispatch quantity.", "warn");

        /* trucks */
        const truckEls = document.querySelectorAll(".truck-entry");
        if (!truckEls.length) return toast("Add at least one truck.", "warn");
        const trucks = [...truckEls].map((el) => ({
          truck_id: el.querySelector(".t-id").value.trim(),
          capacity_kg: parseInt(el.querySelector(".t-cap").value),
        }));

        /* build stops array for /delivery/plan-custom */
        const order = { source: 0, stop: 1, dest: 2 };
        const stops = [...routeStops]
          .sort((a, b) => order[a.role] - order[b.role])
          .map((s) => ({
            name: s.name,
            lat: s.lat,
            lon: s.lon,
            is_depot: s.role === "source",
          }));

        try {
          toast("Planning optimised route‚Ä¶", "info");
          const res = await api("POST", "/delivery/plan-custom", {
            order_quantities: oq,
            trucks,
            rain_expected: document.getElementById("d-rain").checked,
            stops,
          });
          const { assignments, stop_coords } = res;

          /* render cards */
          document.getElementById("d-output").innerHTML =
            `<div class="grid">${assignments
              .map((a) => {
                const mats =
                  Object.entries(a.materials)
                    .map(([k, v]) => `${k}√ó${v}`)
                    .join(", ") || "Empty";
                const u = a.utilization_pct;
                const fc =
                  u < 40
                    ? "var(--red)"
                    : u < 70
                      ? "var(--amber)"
                      : "var(--green)";
                return `
<div class="card" style="margin:0;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.7rem;">
    <span style="font-weight:700;">üöõ ${a.truck_id}</span>
    <span class="sub" style="font-size:.72rem;">${a.capacity_kg.toLocaleString()} kg cap</span>
  </div>
  <div class="prog" style="margin-bottom:.7rem;"><div class="prog-fill" style="width:${u}%;background:${fc};"></div></div>
  <div class="stats" style="margin-bottom:.7rem;">
    <div class="stat"><div class="stat-label">Loaded</div><div class="stat-value">${a.used_kg.toLocaleString()} kg</div></div>
    <div class="stat"><div class="stat-label">Util.</div><div class="stat-value ${u < 40 ? "bad" : u < 70 ? "warn" : "good"}">${u.toFixed(1)}%</div></div>
    <div class="stat"><div class="stat-label">Distance</div><div class="stat-value">${a.distance_km.toLocaleString()} km</div></div>
    <div class="stat"><div class="stat-label">CO‚ÇÇ</div><div class="stat-value ${a.co2_kg > 1000 ? "bad" : a.co2_kg > 200 ? "warn" : "good"}">${a.co2_kg.toLocaleString()} kg</div></div>
  </div>
  <div class="sub" style="font-size:.74rem;margin-bottom:.28rem;"><strong style="color:var(--sub);">Materials</strong> ${mats}</div>
  <div class="sub" style="font-size:.74rem;"><strong style="color:var(--sub);">Route</strong> ${a.route.join(" ‚Üí ")}</div>
</div>`;
              })
              .join("")}</div>`;

          displayTrucksOnMap(assignments, stop_coords);
        } catch (e) {
          toast(e.message, "err");
        }
      }

      /* ‚îÄ‚îÄ Supply Network planner ‚îÄ‚îÄ */
      let snPendingPlace = null;
      let snDestination = null;

      async function snLoadNetworkInfo() {
        try {
          const info = await api("GET", "/supply/network");
          document.getElementById("sn-depot-count").textContent = info.depots;
          document.getElementById("sn-store-count").textContent = info.stores;
          document.getElementById("sn-depot-names").textContent =
            info.depot_names ? info.depot_names.join("  ¬∑  ") : "‚Äî";
        } catch (e) {
          /* non-critical */
        }
      }

      function buildSnReqRows() {
        document.getElementById("sn-req-rows").innerHTML = materials
          .map(
            (m) => `
<div style="display:flex;align-items:center;gap:.7rem;padding:.35rem 0;border-bottom:1px solid var(--border);">
  <span style="flex:1;font-weight:600;font-size:.84rem;">${m.name}</span>
  <span class="sub" style="font-size:.72rem;min-width:90px;">${m.unit} ¬∑ ${m.weight_per_unit} kg/unit</span>
  <div class="field" style="margin:0;min-width:110px;">
    <input id="sn-qty-${m.name}" type="number" value="0" min="0" step="any"
      style="width:100%;text-align:right;" placeholder="0"/>
  </div>
</div>`,
          )
          .join("");
      }

      async function snGeoSearch() {
        const q = document.getElementById("sn-geo-input").value.trim();
        if (!q) return toast("Enter a destination to search.", "warn");
        const res = document.getElementById("sn-geo-results");
        res.innerHTML = `<div style="padding:.5rem .7rem;color:var(--sub);font-size:.8rem;">Searching‚Ä¶</div>`;
        res.style.display = "block";
        try {
          const data = await api("GET", `/geocode?q=${encodeURIComponent(q)}`);
          if (!data.length) {
            res.innerHTML = `<div style="padding:.5rem .7rem;color:var(--sub);font-size:.8rem;">No results.</div>`;
            return;
          }
          res._candidates = data;
          res.innerHTML = data
            .map(
              (c, i) => `
<div onclick="snSelectDest(${i})" style="
  padding:.45rem .7rem;cursor:pointer;font-size:.8rem;
  border-bottom:1px solid var(--border);transition:background .15s;"
  onmouseover="this.style.background='var(--surface2)'"
  onmouseout="this.style.background=''">
  <span style="font-weight:600;">${c.name}</span>
  <span class="sub" style="font-size:.72rem;margin-left:.4rem;">${c.display_name}</span>
</div>`,
            )
            .join("");
        } catch (e) {
          res.innerHTML = `<div style="padding:.5rem .7rem;color:var(--red);font-size:.8rem;">Error: ${e.message}</div>`;
        }
      }

      function snSelectDest(idx) {
        const c = document.getElementById("sn-geo-results")._candidates[idx];
        snDestination = { name: c.name, lat: c.lat, lon: c.lon };
        document.getElementById("sn-geo-results").style.display = "none";
        document.getElementById("sn-geo-input").value = c.name;
        const badge = document.getElementById("sn-dest-badge");
        badge.style.display = "flex";
        document.getElementById("sn-dest-label").textContent =
          `${c.name}  (${c.lat.toFixed(4)}, ${c.lon.toFixed(4)})`;
        if (!deliveryMap) initDeliveryMap();
        deliveryMap.setView([c.lat, c.lon], 7);
        toast(`Destination set: ${c.name}`, "ok");
      }

      function snClearDest() {
        snDestination = null;
        document.getElementById("sn-geo-input").value = "";
        document.getElementById("sn-dest-badge").style.display = "none";
        document.getElementById("sn-geo-results").style.display = "none";
      }

      async function planSupply() {
        if (!snDestination) return toast("Set a destination first.", "warn");

        const requirements = [];
        materials.forEach((m) => {
          const v =
            parseFloat(document.getElementById(`sn-qty-${m.name}`)?.value) || 0;
          if (v > 0) requirements.push({ material: m.name, qty: v });
        });
        if (!requirements.length)
          return toast("Enter at least one material requirement.", "warn");

        toast("Sourcing materials from supply network‚Ä¶", "info");
        document.getElementById("sn-output").innerHTML = `
<div class="card" style="text-align:center;padding:2rem;">
  <div style="font-size:1.8rem;margin-bottom:.5rem;">‚öôÔ∏è</div>
  <div style="color:var(--sub);">Running Clarke-Wright VRP optimizer‚Ä¶</div>
</div>`;

        try {
          const res = await api("POST", "/supply/plan", {
            destination: snDestination,
            requirements,
          });
          renderSupplyPlan(res);
        } catch (e) {
          toast(e.message, "err");
          document.getElementById("sn-output").innerHTML = `
<div class="card"><div class="banner b-err">‚ö† ${e.message}</div></div>`;
        }
      }

      function renderSupplyPlan(plan) {
        const s = plan.summary;
        const hasShortfalls = s.shortfalls > 0;

        /* ‚îÄ summary bar ‚îÄ */
        const summaryHtml = `
<div style="display:flex;gap:.7rem;flex-wrap:wrap;margin-bottom:.7rem;">
  ${[
    ["üöõ", "Trucks", s.total_trucks],
    ["üè≠", "Depots", s.depots_used],
    ["üè™", "Stores", s.stores_sourced],
    ["üì¶", "Total kg", s.total_kg.toLocaleString()],
    ["üõ£Ô∏è", "Total km", s.total_km.toFixed(0)],
    ["üåø", "CO‚ÇÇ kg", s.total_co2_kg.toFixed(1)],
  ]
    .map(
      ([ic, label, val]) => `
  <div class="card" style="margin:0;flex:1;min-width:100px;padding:.7rem .9rem;">
    <div class="sub" style="font-size:.68rem;">${ic} ${label.toUpperCase()}</div>
    <div style="font-size:1.3rem;font-weight:700;">${val}</div>
  </div>`,
    )
    .join("")}
</div>`;

        /* ‚îÄ shortfalls ‚îÄ */
        const shortfallHtml = hasShortfalls
          ? `
<div class="card" style="border-left:3px solid var(--amber);">
  <div class="card-hd" style="color:var(--amber);">‚ö† Shortfalls ‚Äî Insufficient Stock</div>
  ${plan.shortfalls
    .map(
      (sf) => `
  <div style="display:flex;justify-content:space-between;font-size:.82rem;padding:.3rem 0;border-bottom:1px solid var(--border);">
    <span style="font-weight:600;">${sf.material}</span>
    <span>Need <b>${sf.needed_kg.toLocaleString()} kg</b> ¬∑ Available <b>${sf.available_kg.toLocaleString()} kg</b>
      ¬∑ <span style="color:var(--red);">Short ${sf.shortfall_kg.toLocaleString()} kg</span></span>
  </div>`,
    )
    .join("")}
</div>`
          : "";

        /* ‚îÄ depot plans ‚îÄ */
        const TRUCK_COLORS = [
          "#e74c3c",
          "#3498db",
          "#2ecc71",
          "#e67e22",
          "#9b59b6",
          "#1abc9c",
          "#f39c12",
          "#e91e63",
        ];
        let colorIdx = 0;
        const depotHtml = plan.depot_plans
          .map(
            (dp) => `
<div class="card">
  <div class="card-hd">üè≠ ${dp.depot.name}</div>
  <div class="sub" style="font-size:.72rem;margin-bottom:.7rem;">
    ${dp.depot.lat.toFixed(3)}, ${dp.depot.lon.toFixed(3)} ¬∑ ${dp.assignments.length} truck${dp.assignments.length !== 1 ? "s" : ""}
  </div>
  <div class="grid">
  ${dp.assignments
    .map((a) => {
      const col = TRUCK_COLORS[colorIdx++ % TRUCK_COLORS.length];
      const u = a.util_pct;
      const fc =
        u < 40 ? "var(--red)" : u < 70 ? "var(--amber)" : "var(--green)";
      const mats =
        a.stops
          .flatMap((st) => st.materials.map((m) => m.material))
          .join(", ") || "‚Äî";
      return `
<div class="card" style="margin:0;border-left:3px solid ${col};">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.55rem;">
    <span style="font-weight:700;color:${col};">üöõ ${a.truck_id}</span>
    <span class="sub" style="font-size:.7rem;">${(a.capacity_kg / 1000).toFixed(1)}t cap</span>
  </div>
  <div class="prog" style="margin-bottom:.6rem;"><div class="prog-fill" style="width:${u}%;background:${fc};"></div></div>
  <div class="stats" style="margin-bottom:.55rem;">
    <div class="stat"><div class="stat-label">Loaded</div><div class="stat-value">${a.load_kg.toLocaleString()} kg</div></div>
    <div class="stat"><div class="stat-label">Util.</div><div class="stat-value ${u < 40 ? "bad" : u < 70 ? "warn" : "good"}">${u.toFixed(0)}%</div></div>
    <div class="stat"><div class="stat-label">Dist.</div><div class="stat-value">${a.distance_km.toFixed(0)} km</div></div>
    <div class="stat"><div class="stat-label">CO‚ÇÇ</div><div class="stat-value">${a.co2_kg.toFixed(1)} kg</div></div>
  </div>
  <div class="sub" style="font-size:.72rem;margin-bottom:.25rem;"><b>Materials:</b> ${mats}</div>
  <div class="sub" style="font-size:.72rem;"><b>Route:</b> ${a.route.map((r) => r.name).join(" ‚Üí ")}</div>
</div>`;
    })
    .join("")}
  </div>
</div>`,
          )
          .join("");

        document.getElementById("sn-output").innerHTML =
          summaryHtml + shortfallHtml + depotHtml;

        /* ‚îÄ draw map ‚îÄ */
        drawSupplyPlanMap(plan);
      }

      function drawSupplyPlanMap(plan) {
        if (!deliveryMap) initDeliveryMap();
        clearMapLayers();
        const bounds = L.latLngBounds();
        const TRUCK_COLORS = [
          "#e74c3c",
          "#3498db",
          "#2ecc71",
          "#e67e22",
          "#9b59b6",
          "#1abc9c",
          "#f39c12",
          "#e91e63",
        ];
        let colorIdx = 0;

        /* destination pin */
        const dest = plan.destination;
        const destM = L.marker([dest.lat, dest.lon], {
          icon: L.divIcon({
            className: "",
            html: `<div style="background:#c0392b;width:34px;height:34px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;font-size:17px;">üìç</div>
                   <div style="margin-top:2px;background:#c0392b;color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;white-space:nowrap;max-width:100px;overflow:hidden;text-overflow:ellipsis;font-family:sans-serif;">${dest.name}</div>`,
            iconSize: [34, 52],
            iconAnchor: [17, 17],
          }),
        })
          .addTo(deliveryMap)
          .bindPopup(
            `<b style="color:#c0392b;">üìç Destination</b><br/>${dest.name}<br/><small>${dest.lat.toFixed(4)}, ${dest.lon.toFixed(4)}</small>`,
          );
        mapMarkers.push(destM);
        bounds.extend([dest.lat, dest.lon]);

        /* per depot ‚Üí per truck route */
        plan.depot_plans.forEach((dp) => {
          dp.assignments.forEach((a) => {
            const col = TRUCK_COLORS[colorIdx++ % TRUCK_COLORS.length];
            const routeCoords = a.route.map((r) => [r.lat, r.lon]);

            const poly = L.polyline(routeCoords, {
              color: col,
              weight: 3,
              opacity: 0.82,
            }).addTo(deliveryMap);
            mapPolylines.push(poly);

            a.route.forEach((stop, si) => {
              const isDepot = si === 0;
              const isDest = si === a.route.length - 1;
              const sz = isDepot ? 30 : isDest ? 34 : 22;
              const icon = isDepot ? "üè≠" : isDest ? "üìç" : "üè™";
              const m = L.marker([stop.lat, stop.lon], {
                icon: L.divIcon({
                  className: "",
                  html: `<div style="background:${isDepot ? "#2c3e50" : isDest ? "#c0392b" : col};width:${sz}px;height:${sz}px;border-radius:50%;border:2.5px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;font-size:${sz * 0.5}px;">${icon}</div>
                  <div style="margin-top:2px;background:${isDepot ? "#2c3e50" : col};color:#fff;font-size:9px;font-weight:700;padding:1px 4px;border-radius:3px;white-space:nowrap;max-width:80px;overflow:hidden;text-overflow:ellipsis;font-family:sans-serif;">${stop.name}</div>`,
                  iconSize: [sz, sz + 18],
                  iconAnchor: [sz / 2, sz / 2],
                }),
              }).addTo(deliveryMap).bindPopup(`
<div style="font-size:12px;min-width:150px;">
  <b style="color:${col};">üöõ ${a.truck_id}</b><br/>
  <b>${stop.name}</b><br/>
  <small style="color:#777;">${stop.lat.toFixed(4)}, ${stop.lon.toFixed(4)}</small>
</div>`);
              mapMarkers.push(m);
              bounds.extend([stop.lat, stop.lon]);
            });
          });
        });

        if (bounds.isValid())
          deliveryMap.fitBounds(bounds, { padding: [60, 60] });
      }

      /* Init */
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  PROJECT SETUP ‚Äî one-time site config
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      let _setupCoords = null;
      let _setupCandidates = [];

      async function initSetupOverlay() {
        // If project config already saved, skip overlay
        try {
          const cfg = await (await fetch("/api/project-config")).json();
          if (cfg && cfg.dest_lat) {
            document.getElementById("setup-overlay").style.display = "none";
            // Propagate saved site to siteCoords so auto-reorder panel is pre-filled
            siteCoords = {
              lat: cfg.dest_lat,
              lon: cfg.dest_lon,
              name: cfg.dest_name,
            };
            updateArSiteBadge();
            pollPendingBadge();
            return;
          }
        } catch (_) {}
        // Show overlay
        document.getElementById("setup-overlay").style.display = "flex";
      }

      async function setupGeoSearch() {
        const q = document.getElementById("setup-geo-input").value.trim();
        if (!q) return;
        const res = document.getElementById("setup-geo-results");
        res.innerHTML = `<div class="sub" style="font-size:.74rem;">Searching‚Ä¶</div>`;
        try {
          const data = await (
            await fetch(`/api/geocode?q=${encodeURIComponent(q)}`)
          ).json();
          _setupCandidates = data.results || [];
          if (!_setupCandidates.length) {
            res.innerHTML = `<div class="sub" style="font-size:.74rem;color:var(--red);">No results found.</div>`;
            return;
          }
          res.innerHTML = _setupCandidates
            .slice(0, 5)
            .map(
              (c, i) => `
            <div onclick="setupSelectSite(${i})" style="cursor:pointer;padding:.38rem .6rem;
              border-radius:6px;font-size:.76rem;border:1px solid var(--border);
              margin-top:.3rem;background:var(--surface2);" 
              onmouseover="this.style.borderColor='var(--accent)'"
              onmouseout="this.style.borderColor='var(--border)'">
              üìç ${c.name}
            </div>`,
            )
            .join("");
        } catch (e) {
          res.innerHTML = `<div style="color:var(--red);font-size:.74rem;">Error: ${e.message}</div>`;
        }
      }

      function setupSelectSite(idx) {
        const c = _setupCandidates[idx];
        _setupCoords = { lat: c.lat, lon: c.lon, name: c.name };
        document.getElementById("setup-geo-results").innerHTML = "";
        document.getElementById("setup-coords-display").style.display = "block";
        document.getElementById("setup-coords-label").textContent =
          `${c.name} (${c.lat.toFixed(4)}, ${c.lon.toFixed(4)})`;
      }

      async function saveProjectSetup() {
        if (!_setupCoords) {
          alert("Please search and select a destination site first.");
          return;
        }
        const name =
          document.getElementById("setup-project-name").value.trim() ||
          "BuildSense Project";
        try {
          const cfg = await api("POST", "/project-config", {
            name,
            dest_lat: _setupCoords.lat,
            dest_lon: _setupCoords.lon,
            dest_name: _setupCoords.name,
          });
          // Propagate to auto-reorder panel
          siteCoords = {
            lat: cfg.dest_lat,
            lon: cfg.dest_lon,
            name: cfg.dest_name,
          };
          updateArSiteBadge();
          document.getElementById("setup-overlay").style.display = "none";
          toast(`Project site saved: ${cfg.dest_name}`, "ok");
          pollPendingBadge();
        } catch (e) {
          alert("Failed to save: " + e.message);
        }
      }

      function skipSetup() {
        document.getElementById("setup-overlay").style.display = "none";
        pollPendingBadge();
      }

      // Helper: update the AR site badge when siteCoords changes
      function updateArSiteBadge() {
        const badge = document.getElementById("ar-site-badge");
        const label = document.getElementById("ar-site-label");
        if (!badge) return;
        if (siteCoords) {
          label.textContent = siteCoords.name;
          badge.style.display = "flex";
        } else {
          badge.style.display = "none";
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  NAV BADGE ‚Äî polls pending count every 30s
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      let _badgePollTimer = null;

      async function refreshPendingBadge() {
        try {
          const data = await (
            await fetch("/api/pending-reorders/count")
          ).json();
          const n = data.pending_count || 0;
          const badge = document.getElementById("reorder-nav-badge");
          if (n > 0) {
            badge.textContent = n;
            badge.style.display = "inline-flex";
          } else {
            badge.style.display = "none";
          }
        } catch (_) {}
      }

      function pollPendingBadge() {
        refreshPendingBadge();
        clearInterval(_badgePollTimer);
        _badgePollTimer = setInterval(refreshPendingBadge, 30000);
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      //  PENDING REORDERS ‚Äî approval queue
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      async function loadPendingReorders() {
        const out = document.getElementById("pending-reorders-output");
        out.innerHTML = `<div class="sub" style="text-align:center;padding:1rem;">Loading‚Ä¶</div>`;
        try {
          const data = await (
            await fetch("/api/pending-reorders?status=pending")
          ).json();
          const items = data.items || [];

          // Update in-page count badge
          const cb = document.getElementById("pending-count-badge");
          if (items.length) {
            cb.textContent = items.length;
            cb.style.display = "inline";
          } else {
            cb.style.display = "none";
          }

          if (!items.length) {
            out.innerHTML = `
<div style="text-align:center;padding:1.6rem 0;">
  <div style="font-size:2rem;margin-bottom:.5rem;">‚úÖ</div>
  <div style="font-weight:600;color:var(--text);">No pending reorders</div>
  <div class="sub" style="font-size:.76rem;margin-top:.3rem;">The EMA engine will raise requests here automatically as stock falls.</div>
</div>`;
            return;
          }

          // Check if project site is configured
          let hasSite = false;
          try {
            const cfg = await (await fetch("/api/project-config")).json();
            hasSite = !!(cfg && cfg.dest_lat);
            if (hasSite && !siteCoords) {
              siteCoords = {
                lat: cfg.dest_lat,
                lon: cfg.dest_lon,
                name: cfg.dest_name,
              };
              updateArSiteBadge();
            }
          } catch (_) {}

          let html = "";
          if (!hasSite) {
            html += `<div style="padding:.6rem .9rem;background:rgba(251,191,36,.08);
              border-left:3px solid var(--amber);border-radius:var(--radius);
              font-size:.77rem;margin-bottom:.85rem;">
              ‚ö† <b>Project site not configured.</b> 
              <a href="#" onclick="document.getElementById('setup-overlay').style.display='flex';return false;"
                style="color:var(--accent);">Open Setup ‚Üí</a>
              Approval will still work once the site is set.
            </div>`;
          }

          items.forEach((item) => {
            const isCrit = item.critical;
            const borderColor = isCrit ? "var(--red)" : "var(--amber)";
            const bg = isCrit
              ? "rgba(248,113,113,.07)"
              : "rgba(251,191,36,.06)";
            html += `
<div id="pending-item-${item.id}" style="margin-bottom:.75rem;padding:.85rem 1rem;
  background:${bg};border-left:3px solid ${borderColor};border-radius:var(--radius);">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:.5rem;">
    <div>
      <div style="font-weight:700;font-size:.9rem;color:var(--text);">
        ${isCrit ? "üö®" : "‚ö†Ô∏è"} ${item.material}
        ${
          isCrit
            ? `<span style="margin-left:.4rem;font-size:.68rem;background:rgba(248,113,113,.2);
          color:var(--red);padding:.1rem .4rem;border-radius:99px;">CRITICAL</span>`
            : ""
        }
      </div>
      <div class="sub" style="font-size:.74rem;margin-top:.25rem;">
        <b>${item.reorder_qty != null ? item.reorder_qty.toLocaleString() : "‚Äî"} ${item.unit}</b> needed
        &nbsp;¬∑&nbsp; ${item.days_remaining != null ? item.days_remaining.toFixed(1) + " days left" : "stock low"}
        &nbsp;¬∑&nbsp; Stockout: <b>${item.stockout_date || "‚Äî"}</b>
        &nbsp;¬∑&nbsp; EMA: ${item.ema_rate != null ? item.ema_rate.toFixed(2) : "‚Äî"} ${item.unit}/day
      </div>
      <div class="sub" style="font-size:.7rem;margin-top:.15rem;">
        Detected ${item.timestamp ? item.timestamp.replace("T", " ").replace("Z", "") + " UTC" : "‚Äî"}
        &nbsp;¬∑&nbsp; via ${item.source === "batch-check" ? "Batch Scan" : "Daily Log"}
      </div>
    </div>
    <div style="display:flex;gap:.45rem;flex-shrink:0;align-items:center;">
      <button class="btn btn-primary" style="font-size:.78rem;padding:.38rem .85rem;"
        onclick="approvePendingReorder(${item.id}, this)">
        ‚úì Approve &amp; Book
      </button>
      <button class="btn btn-ghost" style="font-size:.78rem;padding:.38rem .75rem;color:var(--red);"
        onclick="rejectPendingReorder(${item.id}, this)">
        ‚úï Reject
      </button>
    </div>
  </div>
  <div id="pending-item-result-${item.id}"></div>
</div>`;
          });

          out.innerHTML = html;
        } catch (e) {
          out.innerHTML = `<div style="color:var(--red);font-size:.79rem;">Error: ${e.message}</div>`;
        }
      }

      async function approvePendingReorder(itemId, btn) {
        btn.disabled = true;
        btn.textContent = "Sourcing‚Ä¶";
        const resultDiv = document.getElementById(
          `pending-item-result-${itemId}`,
        );
        resultDiv.innerHTML = `<div class="sub" style="font-size:.74rem;margin-top:.5rem;">
          üîÑ Finding nearest depot &amp; routing‚Ä¶</div>`;
        try {
          const res = await api(
            "POST",
            `/pending-reorders/approve/${itemId}`,
            {},
          );
          const sp = res.supply_plan || {};
          const sum = sp.summary || {};

          // Build success card
          let routeHTML = "";
          (sp.depot_plans || []).forEach((dp) => {
            const depotName = dp.depot?.name || dp.depot || "Depot";
            routeHTML += `<div style="font-size:.74rem;font-weight:600;color:var(--sub);margin-top:.45rem;">${depotName}</div>`;
            (dp.assignments || []).forEach((a) => {
              routeHTML += `<div style="font-size:.72rem;padding:.15rem 0;border-bottom:1px solid var(--border);">
                üöõ <b>${a.truck_id}</b> ¬∑ ${a.load_kg?.toLocaleString() ?? "‚Äî"} kg ¬∑ ${a.distance_km ?? "‚Äî"} km
                <span style="color:var(--sub);">${(a.route || []).map((r) => r.name || r).join(" ‚Üí ")}</span>
              </div>`;
            });
          });

          resultDiv.innerHTML = `
<div style="margin-top:.6rem;padding:.65rem .85rem;background:var(--surface2);
  border-radius:var(--radius);border:1px solid var(--border);">
  <div style="font-weight:700;font-size:.78rem;color:var(--green);margin-bottom:.4rem;">
    ‚úÖ Order Approved &amp; Booked
  </div>
  <div class="stats" style="margin:.3rem 0;">
    <div class="stat"><div class="stat-label">Trucks</div><div class="stat-value">${sum.total_trucks ?? "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Total kg</div><div class="stat-value">${sum.total_kg?.toLocaleString() ?? "‚Äî"}</div></div>
    <div class="stat"><div class="stat-label">Distance</div><div class="stat-value">${sum.total_km?.toLocaleString() ?? "‚Äî"} km</div></div>
    <div class="stat"><div class="stat-label">CO‚ÇÇ</div><div class="stat-value">${sum.total_co2_kg?.toLocaleString() ?? "‚Äî"} kg</div></div>
  </div>
  ${routeHTML}
</div>`;

          // Fade out the action buttons
          btn
            .closest("div[style*='display:flex']")
            .querySelector("button:last-child").style.display = "none";
          btn.textContent = "‚úì Approved";
          btn.style.background = "var(--green)";
          btn.style.color = "#0d0f18";
          btn.disabled = true;

          // Update nav badge
          refreshPendingBadge();
          toast(`Reorder for ${res.item?.material} approved & booked!`, "ok");
        } catch (e) {
          resultDiv.innerHTML = `<div style="color:var(--red);font-size:.76rem;margin-top:.4rem;">Error: ${e.message}</div>`;
          btn.disabled = false;
          btn.textContent = "‚úì Approve & Book";
        }
      }

      async function rejectPendingReorder(itemId, btn) {
        if (!confirm("Reject this reorder request?")) return;
        btn.disabled = true;
        try {
          await api("POST", `/pending-reorders/reject/${itemId}`, {});
          const card = document.getElementById(`pending-item-${itemId}`);
          card.style.opacity = "0.4";
          card.style.pointerEvents = "none";
          const resultDiv = document.getElementById(
            `pending-item-result-${itemId}`,
          );
          resultDiv.innerHTML = `<div style="font-size:.74rem;color:var(--sub);margin-top:.4rem;">‚úï Rejected</div>`;
          refreshPendingBadge();
          toast("Reorder request rejected.", "warn");
        } catch (e) {
          toast("Error: " + e.message, "err");
          btn.disabled = false;
        }
      }

      window.addEventListener("DOMContentLoaded", async () => {
        document.getElementById("p3-date").valueAsDate = new Date();
        await initSetupOverlay();
        try {
          await loadMaterials();
          addTruck();
          addTruck();
          buildSnReqRows();
          snLoadNetworkInfo();
          pollPendingBadge();
        } catch (e) {
          document.getElementById("mat-cards").innerHTML = `
<div class="card" style="grid-column:1/-1;">
  <div class="banner b-err">‚ö† Cannot connect to API at ${API}. Start the server: python api/server.py</div>
</div>`;
        }
      });
    </script>
  </body>
</html>
